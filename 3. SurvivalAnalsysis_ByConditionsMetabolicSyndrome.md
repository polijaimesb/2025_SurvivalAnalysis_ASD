# Survival analysis: identifying the risk of developing metabolic syndrome-related conditions after utilization of psychotropic medication in individuals with ASD 

This R Markdown contains the survival analysis formatting for ASD cohort
who received psychotropic polypharmacy and might have metabolic syndrome
diagnosis.

    library(dplyr)
    library(data.table)
    library(survival)
    library(survminer)
    library(tableone)
    library(stats)
    library(tidyr)
    library(stringr)
    library(sjPlot)
    library(tidyverse)
    library(tidytable)
    library(lsr)
    library(car)

First, open the file. Only oral - 15 different drug classes

    #30 days
    polypharmacy_Allevents <- fread("Y:/Paula/Files_finish/NewFiles/2to64/AllPharmacotherapy/SensitivityAnalysis/NewApproach_PolyMethodology/30225_AllPatients_MetabolicSyndrome_PP30days_NC_1dayGap_Oral.csv")


    # #1 day 
    # polypharmacy_Allevents <- fread("Y:/Paula/Files_finish/NewFiles/2to64/AllPharmacotherapy/SensitivityAnalysis/NewApproach_PolyMethodology/30225AllPatients_MetabolicSyndrome_PP1days_NC_1dayGap_Oral.csv")

    #Add drug classes
    drug_classes_meds <- fread("Y:/Paula/Files_finish/Medications_and_Drug_Classes.csv")

    # Step 1: Separate multiple medications into rows
    medications_long <- polypharmacy_Allevents %>%
      select(medication_name) %>% 
      mutate(medication_name_all = medication_name) %>% 
      unique 

    medications_long <- medications_long[, .(medication_name = unlist(strsplit(medication_name,",\\s*"))), by = .(medication_name_all)]

    # Step 2: Join with the drug class dataframe
    medications_long <- medications_long %>%
      left_join(drug_classes_meds, by = c("medication_name" = "Medication"))

    # Step 3: Group by original row and concatenate unique drug classes
    medications_final <- medications_long %>%
      group_by(medication_name_all) %>%
      summarise(drug_class_combined = paste(unique(Drug_Class), collapse = ", ")) %>%
      ungroup()

    #Join
    polypharmacy_Allevents <- polypharmacy_Allevents %>% 
      left_join(medications_final, by = c("medication_name" = "medication_name_all"))

Only oral - classification according with their intended use

    #Add drug classes (classified as intended medication use)
    drug_classes_meds_use <- fread("Y:/Paula/Files_finish/NewFiles/DrugClassification_option1.csv")

    # Step 1: Separate multiple medications into rows
    medications_long <- polypharmacy_Allevents %>%
      select(medication_name) %>% 
      mutate(medication_name_all = medication_name) %>% 
      unique 

    medications_long <- medications_long[, .(medication_name = unlist(strsplit(medication_name,",\\s*"))), by = .(medication_name_all)]

    # Step 2: Join with the drug class dataframe
    medications_long <- medications_long %>%
      left_join(drug_classes_meds_use, by = c("medication_name" = "medication"))

    # Step 3: Group by original row and concatenate unique drug classes
    medications_final <- medications_long %>%
      group_by(medication_name_all) %>%
      summarise(drug_class_combined = paste(unique(classification), collapse = ", ")) %>%
      ungroup()

    #Join
    polypharmacy_Allevents <- polypharmacy_Allevents %>% 
      left_join(medications_final, by = c("medication_name" = "medication_name_all"))

Sensitivity analysis files - 1, 60, 90 days

    #60 days 
    polypharmacy_select <- 60
    polypharmacy_Allevents <- fread("Y:/Paula/Files_finish/NewFiles/2to64/AllPharmacotherapy//SensitivityAnalysis_MetS/NewApproach_PolyMethodology/30225_AllPatients_MetabolicSyndrome_PP60days_NC_1dayGap_Oral.csv")

    #90 days 
    polypharmacy_select <- 90
    polypharmacy_Allevents <- fread("Y:/Paula/Files_finish/NewFiles/2to64/AllPharmacotherapy/SensitivityAnalysis_MetS/NewApproach_PolyMethodology/30225_AllPatients_MetabolicSyndrome_PP90days_NC_1dayGap_Oral.csv")

    #1 day
    polypharmacy_select <- 1

    polypharmacy_Allevents <- fread("Y:/Paula/Files_finish/NewFiles/2to64/AllPharmacotherapy/SensitivityAnalysis_MetS/NewApproach_PolyMethodology/30225AllPatients_MetabolicSyndrome_PP1days_NC_1dayGap_Oral.csv")

    polypharmacy_select <- 30
    #30 day
    polypharmacy_Allevents <- fread("Y:/Paula/Files_finish/NewFiles/2to64/AllPharmacotherapy/SensitivityAnalysis_MetS/NewApproach_PolyMethodology/30225_AllPatients_MetabolicSyndrome_PP30days_NC_1dayGap_Oral.csv")

Split into monotherapy/polypharmacy.

    monotherapy_events <- polypharmacy_Allevents %>% 
      group_by(PATIENT_ID) %>% 
      filter(all(medication == "Monotherapy")) %>% 
      ungroup()

    polypharmacy_events <- polypharmacy_Allevents %>% 
      group_by(PATIENT_ID) %>% 
      filter(any(grepl("^Polypharmacy", medication))) %>% 
      ungroup()

    #File that contains the diagnosis codes 
    metabolic_syndrome_related_diagn <- fread("Y:/Paula/Files_finish/NewFiles/2to64/041025_MetabolicSyndromeDiagnosis_PharmacotherapyAndABA_AllYears.csv")

All other files.

    #Demographics 
    demographicASD<-read.csv("Y:/enrll_synth.csv")

    #To see if the patients had any record after final episode (if episode end is not 2022-12-01 or greater)
    RecordasAnyClaim <-  fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
      mutate(any_record = from_dt) %>%
      select(pat_id, any_record) %>%
      filter(pat_id %in% unlist(unique(metabolic_syndrome_related_diagn$pat_id))) 

    colnames(RecordasAnyClaim)[1] <- "PATIENT_ID"

    invisible(gc())

# Time-varying predictors

First, in order to adequately use the data, we need to format the data
accordingly, to capture the time-varying predictors.

    #Filtering just the polypharmacy  events 
    polypharmacy_events <- polypharmacy_events %>% 
      filter(grepl("^Polypharmacy", medication))

    #Unify the events
    allEvents_metabolicSyndrome <- bind_rows(polypharmacy_events, monotherapy_events)

# Identification of metabolic syndrome

In order to be classified as metabolic syndrome, the patient must have
at least 3 out the 5 conditions. However, we want to run the analysis by
each of the conditions.

    metabolic_syndrome_related_diagn_Last <- metabolic_syndrome_related_diagn %>% 
      arrange(pat_id, from_dt, descrip_diag) %>% 
      group_by(pat_id, descrip_diag) %>% 
      slice(1) %>% 
      ungroup()

\#Follow up - sensitivity analysis We ran a sensitivity analysis for the
follow-up, ranging from 30, 60, 90, 180, and 365 days. To do that, we
created a variable that contains the number of days per range, and we
ran each of them according to the analysis we want to run.

## Follow-up 30 days (1 month) after final episode.

    follow_up <- 30

## Follow-up 60 days (2 months) after final episode.

    follow_up <- 60

## Follow-up 90 days (3 months) after final episode.

    follow_up <- 90

## Follow-up 180 days (6 months) after final episode.

    follow_up <- 180

## Follow-up 365 days (12 months) after final episode.

    follow_up <- 365

## Follow-up xx days after final episode.

To capture metabolic syndrome after exposure, and also to ensure that
the metabolic syndrome diagnosed is related to the event instead of
other factors, we allow xx months of follow-up if the patient is active
during that time. For the final event, we are going to use the final
record from each patient and see if it is greater than xx days after the
final episode. IF NOT, that patient is not going to take into account.
This is to be fair with the patients that have the xx days of follow-up.

First, we will exclude the final events that does not have xx days of
follow-up at the end (because it ends close to the final date of the
cohort (2022-12-01) ).

    allEvents_metabolicSyndrome <- allEvents_metabolicSyndrome %>% 
      mutate(
        SixMonths = as.numeric(as.Date("2022-12-01", "%Y-%m-%d") - episode.end)
      ) %>% 
      filter(
        SixMonths >= follow_up
      )

Now, we are going to modify the last event to capture the xx days prior
the end of the event.

    Max_RecordClaim <- RecordasAnyClaim %>% 
      arrange(PATIENT_ID, desc(any_record)) %>% 
      group_by(PATIENT_ID) %>% 
      slice(1) %>% 
      ungroup()
      
    FinalDate_6months <- allEvents_metabolicSyndrome %>% 
      arrange(desc(episode.end), PATIENT_ID) %>% 
      group_by(PATIENT_ID) %>% 
      slice(1) %>% 
      ungroup() %>% 
      left_join(Max_RecordClaim, by = "PATIENT_ID") %>% 
      group_by(PATIENT_ID) %>% 
      mutate(
        episode.end = episode.end + follow_up
        ) %>% 
      ungroup() %>%
      select(-any_record)

    #Format the dataframe 
    allEvents_metabolicSyndrome <- allEvents_metabolicSyndrome %>% 
      arrange(episode.start, PATIENT_ID) %>%
      group_by(PATIENT_ID) %>% 
      mutate(
        start_med = episode.start, 
        end_med  = episode.end,
        lagged_tstart = lead(episode.start),
        episode.start = episode.end,
        episode.end = episode.end + follow_up
        ) %>% 
     ungroup()

Now, we are going to generate a binary variable that indicates that when
a patient has more than 1 events, if the follow-up period overlaps the
next event.

    allEvents_metabolicSyndrome <- allEvents_metabolicSyndrome %>% 
      arrange(episode.start, PATIENT_ID) %>%
      group_by(PATIENT_ID) %>% 
      mutate(
        overlaps_event = if_else(row_number() != n() & 
                                   (lagged_tstart >= episode.start & lagged_tstart <= episode.end), 
                                 1, 0)
        ) %>% 
     ungroup()

# By metabolic syndrome conditions

For the creation of each df by condition, I created the following
function.

    Creation_df_ByCondition <- function(condition_Mest){

      #Bind rows with the entire dataset
      allEvents_metabolicSyndrome$episode.start <- as.Date(allEvents_metabolicSyndrome$episode.start, "%Y-%m-%d")
      allEvents_metabolicSyndrome$episode.end <- as.Date(allEvents_metabolicSyndrome$episode.end, "%Y-%m-%d")

      
      #Identify the time to event by each event
      df_eachCondition <- allEvents_metabolicSyndrome  %>%
        left_join(select(metabolic_syndrome_related_diagn_Last, 
                         PATIENT_ID, 
                         from_dt, 
                         descrip_diag), 
                  by = "PATIENT_ID") %>% 
      mutate( from_dt = as.Date(from_dt, "%Y-%m-%d"), 
              episode.end = if_else(episode.end > as.Date("2022-12-01", "%Y-%m-%d"), 
                                    as.Date("2022-12-01", "%Y-%m-%d"), 
                                    episode.end)) %>% 
      group_by(PATIENT_ID) %>% 
      mutate(start_followUp = as.Date(min(episode.start), "%Y-%m-%d"), 
             tstart = as.numeric(episode.start - start_followUp), 
             tstop = as.numeric(episode.end - start_followUp), 
             futime = as.numeric(from_dt - start_followUp),
             fustat = if_else(descrip_diag == condition_Mest & 
                                (futime >= tstart  & futime <= tstop),
                              1, 
                              0)) %>% 
      ungroup() %>% 
        ungroup() %>%
        mutate(
          fustat = ifelse(is.na(fustat), 0, fustat),
          futime = ifelse(is.na(futime), 0, futime)
        ) %>% 
        filter(futime >= 0)

      

      print("Number of patients per condition")
      print(length(unique(df_eachCondition$PATIENT_ID)))
      
      
      df_eachCondition <- df_eachCondition %>%
        group_by(PATIENT_ID) %>%  # Group by patient (replace with your patient identifier column if available)
        mutate(first_event_row = which(fustat == 1)[1]) %>%  # Find the first row where event (fustat == 1) happens
        filter(row_number() <= first_event_row | is.na(first_event_row)) %>%  # Keep rows up to the first event
        ungroup()  # Ungroup to return the data to a regular dataframe
      
      print("Number of patients per condition")
      print(length(unique(df_eachCondition$PATIENT_ID)))
      
      
      ##  Incorporating demographics 
      claims_diagnosis <-  fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
      select(pat_id, from_dt, starts_with("diag")) %>%
      filter(pat_id %in% unlist(unique(df_eachCondition$PATIENT_ID)) & 
               diagprc_ind != -1) %>% 
      select(-diagprc_ind) %>%
      pivot_longer(
        cols = -c(pat_id,from_dt), 
        names_to = "diagn_code",
        values_to = "dx_cd"
      ) %>% 
      select(-diagn_code) %>%
      distinct() %>% 
      filter(dx_cd != "" & 
               !is.na(dx_cd)) %>% 
      arrange(from_dt, pat_id) %>% 
      distinct() %>% 
      mutate(year = as.numeric(as.numeric(format(from_dt, '%Y'))))
      
      invisible(gc())

    #Select first age at initiation 
    StartDate_Init <- df_eachCondition %>% 
      arrange(PATIENT_ID, start_med) %>% 
      group_by(PATIENT_ID) %>% 
      slice(1) %>% 
      ungroup() %>% 
      select(PATIENT_ID, start_med) %>% 
      mutate(year_start = as.numeric(substr(start_med, 1, 4)))
      

    depressive_disorder_df <- claims_diagnosis %>% 
      filter(str_starts(dx_cd, "F32") | #For ICD-10
               str_starts(dx_cd, "F33") |
               dx_cd == "F341" |
               (str_starts(dx_cd, "2962") | #For ICD-9
                  str_starts(dx_cd, "2963") | 
                  (dx_cd == "3004" | dx_cd == "30112") )) %>% 
      unique 


    anxiety_disorder_df <- claims_diagnosis %>% 
      filter(str_starts(dx_cd, "F40") | #For ICD-10
               str_starts(dx_cd, "F41") |
               str_starts(dx_cd, "F42") |
               
               (str_starts(dx_cd, "3002") | #For ICD-9
                  str_starts(dx_cd, "3000") | 
                  dx_cd %in% c("3003","3063") )) %>% 
      unique 


    bipolar_disorder_df <- claims_diagnosis %>% 
      filter(str_starts(dx_cd, "F31") | 
               dx_cd == "F340" | 
               (str_starts(dx_cd, "2964") | 
                  str_starts(dx_cd, "2965") | 
                  str_starts(dx_cd, "2966") | 
                  dx_cd %in% c("2967","29680", "29689")) 
             ) %>% 
      unique 


    schiz_df <- claims_diagnosis %>% 
      filter(str_starts(dx_cd, "F20") | 
               str_starts(dx_cd, "F21") | 
               str_starts(dx_cd, "F25") | 
               (dx_cd %in% c("29530",
                             "29510", 
                             "29590",
                             "29560",
                             "29520",
                             "29540", 
                             "29580",
                             "30122",
                             "29570"))
             ) %>% 
      unique
      
      ADHD_df <- claims_diagnosis %>% 
        filter(str_starts(dx_cd, "F90") | 
                 str_starts(dx_cd, "3140")
               ) %>% 
        unique
      
      
      ID_df <- claims_diagnosis %>% 
        filter(grepl("^F7[0-9]", dx_cd) | 
                 grepl("^31[7-9]", dx_cd)) %>% 
        unique
      
      #Select first age at initiation 
      StartDate_Init <- df_eachCondition %>% 
        arrange(PATIENT_ID, start_med) %>% 
        group_by(PATIENT_ID) %>% 
        slice(1) %>% 
        ungroup() %>% 
        select(PATIENT_ID, start_med) %>% 
        mutate(year_start = as.numeric(substr(start_med, 1, 4)))
      
      #Identify if the patient has a history of depression, anxiety, bipolar disorder or schizophrenia
      depressive_disorder_df_beforeFirst <- depressive_disorder_df %>% 
        mutate(PATIENT_ID = pat_id) %>% 
        select(-pat_id) %>% 
        left_join(StartDate_Init, by = "PATIENT_ID") %>% 
        filter(from_dt <= start_med) %>% 
        arrange(PATIENT_ID, desc(from_dt)) %>% #Extract just the final one
        group_by(PATIENT_ID) %>% 
        slice(1) %>% 
        ungroup() %>% 
        mutate(depressive_diagn_hist = 1) 
      
      
      anxiety_disorder_df_beforeFirst <- anxiety_disorder_df %>% 
        mutate(PATIENT_ID = pat_id) %>% 
        select(-pat_id) %>% 
        left_join(StartDate_Init, by = "PATIENT_ID") %>% 
        filter(from_dt <= start_med) %>% 
        arrange(PATIENT_ID, desc(from_dt)) %>% #Extract just the final one
        group_by(PATIENT_ID) %>% 
        slice(1) %>% 
        ungroup() %>% 
        mutate(anxiety_diagn_hist = 1) 
      
      
      bipolar_disorder_df_beforeFirst <- bipolar_disorder_df %>% 
        mutate(PATIENT_ID = pat_id) %>% 
        select(-pat_id) %>% 
        left_join(StartDate_Init, by = "PATIENT_ID") %>% 
        filter(from_dt <= start_med) %>% 
        arrange(PATIENT_ID, desc(from_dt)) %>% #Extract just the final one
        group_by(PATIENT_ID) %>% 
        slice(1) %>% 
        ungroup() %>% 
        mutate(bipolar_diagn_hist = 1) 
      
      schiz_df_beforeFirst <- schiz_df %>% 
        mutate(PATIENT_ID = pat_id) %>% 
        select(-pat_id) %>% 
        left_join(StartDate_Init, by = "PATIENT_ID") %>% 
        filter(from_dt <= start_med) %>% 
        arrange(PATIENT_ID, desc(from_dt)) %>% #Extract just the final one
        group_by(PATIENT_ID) %>% 
        slice(1) %>% 
        ungroup() %>% 
        mutate(schizo_diagn_hist = 1) 
      
      ADHD_df_beforeFirst <- ADHD_df %>% 
        mutate(PATIENT_ID = pat_id) %>% 
        select(-pat_id) %>% 
        left_join(StartDate_Init, by = "PATIENT_ID") %>% 
        filter(from_dt <= start_med) %>% 
        arrange(PATIENT_ID, desc(from_dt)) %>% #Extract just the final one
        group_by(PATIENT_ID) %>% 
        slice(1) %>% 
        ungroup() %>% 
        mutate(ADHD_diagn_hist = 1) 
      
      ID_df_beforeFirst <- ID_df %>% 
        mutate(PATIENT_ID = pat_id) %>% 
        select(-pat_id) %>% 
        left_join(StartDate_Init, by = "PATIENT_ID") %>% 
        filter(from_dt <= start_med) %>% 
        arrange(PATIENT_ID, desc(from_dt)) %>% #Extract just the final one
        group_by(PATIENT_ID) %>% 
        slice(1) %>% 
        ungroup() %>% 
        mutate(ID_diagn_hist = 1) 
      
      Sex_State_cohortMetabolicSyndrome_poly <- demographicASD %>% 
        filter(pat_id %in% unique(df_eachCondition$PATIENT_ID)) %>% 
        select(pat_id, der_sex, pat_state, der_yob, pat_region) %>% 
        mutate(PATIENT_ID = pat_id, 
               pat_region = ifelse(pat_region == "", "Unknown", pat_region)) %>% 
        select(-pat_id) %>% 
        left_join(StartDate_Init, by = "PATIENT_ID") %>%
        mutate(age_startFollowUp = year_start - der_yob, 
               age_startFollowUp_group = case_when(
                 age_startFollowUp >= 2 & age_startFollowUp < 13 ~ "Early, Middle and Late Childhood", 
                 age_startFollowUp >= 13 & age_startFollowUp < 18 ~ "Adolescence", 
                 age_startFollowUp >= 18  ~ "Adulthood"
               )) %>% 
        select(-year_start) %>% 
        left_join(select(depressive_disorder_df_beforeFirst, PATIENT_ID, depressive_diagn_hist), by = "PATIENT_ID") %>% 
        left_join(select(anxiety_disorder_df_beforeFirst, PATIENT_ID, anxiety_diagn_hist), by = "PATIENT_ID") %>% 
        left_join(select(bipolar_disorder_df_beforeFirst, PATIENT_ID, bipolar_diagn_hist), by = "PATIENT_ID") %>% 
        left_join(select(schiz_df_beforeFirst, PATIENT_ID, schizo_diagn_hist), by = "PATIENT_ID") %>% 
        left_join(select(ADHD_df_beforeFirst, PATIENT_ID, ADHD_diagn_hist), by = "PATIENT_ID") %>% 
        left_join(select(ID_df_beforeFirst, PATIENT_ID, ID_diagn_hist), by = "PATIENT_ID") %>% 
        mutate(
          depressive_diagn_hist = ifelse(is.na(depressive_diagn_hist), "No", "Yes"), 
          anxiety_diagn_hist = ifelse(is.na(anxiety_diagn_hist), "No", "Yes"), 
          bipolar_diagn_hist = ifelse(is.na(bipolar_diagn_hist), "No", "Yes"),
          schizo_diagn_hist = ifelse(is.na(schizo_diagn_hist), "No", "Yes"),
          ADHD_diagn_hist = ifelse(is.na(ADHD_diagn_hist), "No", "Yes"),
          ID_diagn_hist = ifelse(is.na(ID_diagn_hist), "No", "Yes")
        )
      
        
      #Join and exclude patients with unknown info in patients' state 
      df_eachCondition <- df_eachCondition %>% 
        left_join(select(Sex_State_cohortMetabolicSyndrome_poly, PATIENT_ID, 
                         der_sex, pat_region, starts_with("age_start"), 
                         depressive_diagn_hist, anxiety_diagn_hist, bipolar_diagn_hist,
                         schizo_diagn_hist, ADHD_diagn_hist, ID_diagn_hist), by = "PATIENT_ID") %>% 
        filter(pat_region != "Unknown")
      
      print("Number of patients per condition")
      print(length(unique(df_eachCondition$PATIENT_ID)))
      
      
      #For the duration of the events 
      df_eachCondition <- df_eachCondition %>% 
        mutate(
          end_med = as.Date(end_med, "%Y-%m-%d"), 
          start_med = as.Date(start_med, "%Y-%m-%d"),
          episode.duration = as.numeric(end_med - start_med))

      df_eachCondition <- df_eachCondition %>% 
        mutate(
          duration_ByEvent = 
            case_when(
              episode.duration >= 1 & episode.duration < 365 ~ "1 to 365",
              episode.duration >= 365  ~ "Greater than 365"
            )
          ) %>%
        ungroup()
      
      df_eachCondition <- df_eachCondition %>% 
        mutate(overlaps_event = if_else(overlaps_event == 1, "Yes", "No"))

      #Include the number of medication taken 
      

      df_eachCondition <- df_eachCondition %>%
        mutate(
          Num_MedTaken =
            case_when(
              medication == "Monotherapy" ~ "Monotherapy",
              med_count <= 3 & grepl("^Polypharmacy", medication) ~ "Low Polypharmacy",
              med_count > 3 & grepl("^Polypharmacy", medication) ~ "High Polypharmacy"
            )
          ) %>%
        ungroup()
      
      #----- New: add variable that indicates if antipsychotics or SSRIs were taken during the episode.
      # Drug classes itself
    #df_eachCondition <- df_eachCondition %>%
    #  mutate(antipsychotics_use = str_detect(drug_class_combined, "Atypical Antipsychotics"),
    #         SSRIs_use = str_detect(drug_class_combined, "SSRIs"))
      
      #------ Medication classificaiton for intended use 
      df_eachCondition <- df_eachCondition %>%
      mutate(sleep_insomnia = str_detect(drug_class_combined, "Sleep/Insomnia"),
             aggr_behav = str_detect(drug_class_combined, "Aggressive behavior"), 
             depress_anx_ocd_repet_behav = str_detect(drug_class_combined, "Depression/Anxiety/OCD-like repetitive behaviors"), 
             irritability = str_detect(drug_class_combined, "Irritability"), 
             antiseizure_behav = str_detect(drug_class_combined, "Anti-seizure meds that also have some effect on behavior"), 
             adhd_meds = str_detect(drug_class_combined, "ADHD stimulant medications"),
             adhd_aggr = str_detect(drug_class_combined, "ADHD medications for aggression only")
             )
      
      
      
      df_eachCondition <- as.data.frame(df_eachCondition)
      
      #Change the reference 
      df_eachCondition$der_sex <- factor(df_eachCondition$der_sex, 
                                                     level = c("M", "F"))
      
      df_eachCondition$age_startFollowUp_group <- factor(df_eachCondition$age_startFollowUp_group, 
                                                                      level = c("Adulthood", 
                                                                                "Early, Middle and Late Childhood",
                                                                                "Adolescence")
                                                         )
      
      df_eachCondition$pat_region <- factor(df_eachCondition$pat_region,
                                        level = c("MW",
                                                  "E",
                                                  "S",
                                                  "W"))

      
      df_eachCondition$Num_MedTaken <- factor(df_eachCondition$Num_MedTaken,
                                        level = c("Monotherapy",
                                                  "Low Polypharmacy",
                                                  "High Polypharmacy"))
      


      # df_eachCondition$antipsychotics_use <- factor(df_eachCondition$antipsychotics_use)
      # df_eachCondition$SSRIs_use <- factor(df_eachCondition$SSRIs_use)
      
      return(df_eachCondition)
    }

## Weight gain

Here, we called the function above to identify the patients with the
weight gain diagnosis.

    metabolic_syndrome_related_diagn_Last <- metabolic_syndrome_related_diagn_Last %>% 
      mutate(PATIENT_ID = pat_id)

    WeightGain_Exposed_3out5 <- Creation_df_ByCondition("Weight gain") 

    #Drug class itself
    # WeightGain_Exposed_3out5 <- WeightGain_Exposed_3out5 %>% 
    #   mutate(
    #     SSRIs_use = if_else(SSRIs_use == "FALSE", "No", "Yes"), 
    #     antipsychotics_use = if_else(antipsychotics_use == "FALSE", "No", "Yes")
    #   )

    #Classification of medications according with intended use 
    WeightGain_Exposed_3out5 <- WeightGain_Exposed_3out5 %>%
    mutate(sleep_insomnia = if_else(sleep_insomnia == "FALSE", "No", "Yes"),
           aggr_behav = if_else(aggr_behav == "FALSE", "No", "Yes"), 
           depress_anx_ocd_repet_behav = if_else(depress_anx_ocd_repet_behav == "FALSE", "No", "Yes"), 
           irritability = if_else(irritability == "FALSE", "No", "Yes"),
           antiseizure_behav = if_else(antiseizure_behav == "FALSE", "No", "Yes"),
           adhd_meds = if_else(adhd_meds == "FALSE", "No", "Yes"),
           adhd_aggr = if_else(adhd_aggr == "FALSE", "No", "Yes")
           )

### Cox proportional hazard model

Run the Cox proportional hazard model taking into consideration the
time-varying predictors.

    #o sleep_insomnia +  aggr_behav+ depress_anx_ocd_repet_behav+ irritability+ antiseizure_behav+adhd_meds+ adhd_aggr  +
    cox_psychotropic_WG <- coxph(Surv(tstart, tstop, fustat) ~  Num_MedTaken + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist,
                              data = WeightGain_Exposed_3out5)

    summary(cox_psychotropic_WG)

#### Forest plot for publication

Generate the forest plot for the hazard ratios.

    # Fit Cox model (assuming your model is already created)
    cox_model <- cox_psychotropic_WG

    # Extract hazard ratios (HR)
    cox_summary <- broom::tidy(cox_model, exponentiate = TRUE)

    # Extract confidence intervals separately
    conf_intervals <- confint(cox_model)
    conf_intervals <- exp(conf_intervals)  # Convert log HR to HR

    # Convert confidence intervals to a dataframe
    conf_df <- data.frame(term = rownames(conf_intervals),
                          lower_CI = conf_intervals[, 1],
                          upper_CI = conf_intervals[, 2])

    # Merge the two dataframes
    cox_df <- left_join(cox_summary, conf_df, by = "term")

    # Select relevant columns
    cox_df <- cox_df %>%
      select(term, estimate, lower_CI, upper_CI, p.value) %>%
      rename(HR = estimate)

    # Identify reference categories manually
    reference_rows <- data.frame(
      term = c("der_sexMale", "age_startFollowUp_groupReference", "pat_regionReference",
               "overlaps_eventRef","depressive_diagn_histRef", "anxiety_diagn_histRef",
               "bipolar_diagn_histRef", "schizo_diagn_histRef", "ADHD_diagn_histRef", 
               "ID_diagn_histRef", "duration_ByEventRef", "Num_MedTakenRef", "sleep_insomniaRef", "aggr_behavRef", "depress_anx_ocd_repet_behavRef", "irritabilityRef", "antiseizure_behavRef", "adhd_medsRef", "adhd_aggrRef"),
      HR = 1,  # Reference category HR is always 1
      lower_CI = 1,  # Reference confidence interval is also 1
      upper_CI = 1,
      p.value = NA  # p-value is not applicable for reference categories
    )

    #Names of the category
    caterogies_rows <- data.frame(
      term = c("sex", "age", "region",
               "overlaps","depression", "anxiety",
               "bipolar", "schizo", "adhd", 
               "id", "duration", "medications", "sleep_insomnia_class", "aggr_behav_class",
               "depress_anx_ocd_repet_behav_class", "irritability_class",
               "antiseizure_behav_class", 
               "adhd_meds_class", "adhd_aggr_class"),
      HR = NA,  # Reference category HR is always 1
      lower_CI = NA,  # Reference confidence interval is also 1
      upper_CI = NA,
      p.value = NA  # p-value is not applicable for reference categories
    )

    # Append reference categories to the cox_df
    cox_df <- bind_rows(cox_df, reference_rows)
    cox_df <- bind_rows(cox_df, caterogies_rows)


    cox_df[order(cox_df$term),]

    custom_order <- c(
      "medications", "Num_MedTakenRef", "Num_MedTakenLow Polypharmacy", "Num_MedTakenHigh Polypharmacy",
      "overlaps", "overlaps_eventRef", "overlaps_eventYes",
      "duration", "duration_ByEventRef", "duration_ByEventGreater than 365",
      "sleep_insomnia_class", "sleep_insomniaRef", "sleep_insomniaYes", 
      "aggr_behav_class", "aggr_behavRef", "aggr_behavYes", 
      "irritability_class", "irritabilityRef",  "irritabilityYes",
      "depress_anx_ocd_repet_behav_class", "depress_anx_ocd_repet_behavRef", "depress_anx_ocd_repet_behavYes", 
      "antiseizure_behav_class", "antiseizure_behavRef", "antiseizure_behavYes",
      "adhd_meds_class", "adhd_medsRef", "adhd_medsYes", 
      "adhd_aggr_class", "adhd_aggrRef", "adhd_aggrYes",
      # "ssris_used", "SSRIs_useRef", "SSRIs_useYes",
      # "aa_used", "antipsychotics_useRef", "antipsychotics_useYes",
      "sex","der_sexMale", "der_sexF", 
      "region", "pat_regionReference", "pat_regionE", "pat_regionS", "pat_regionW",
      "age", "age_startFollowUp_groupReference", "age_startFollowUp_groupAdolescence", "age_startFollowUp_groupEarly, Middle and Late Childhood",
      "depression", "depressive_diagn_histRef", "depressive_diagn_histYes",
      "anxiety", "anxiety_diagn_histRef", "anxiety_diagn_histYes",
      "bipolar","bipolar_diagn_histRef", "bipolar_diagn_histYes",
      "schizo", "schizo_diagn_histRef", "schizo_diagn_histYes",
      "adhd", "ADHD_diagn_histRef", "ADHD_diagn_histYes",
      "id", "ID_diagn_histRef", "ID_diagn_histYes"
    )

    cox_df$term <- factor(cox_df$term, levels = rev(custom_order))  # reversed so top = first

    cox_df <- cox_df %>% 
      filter(!is.na(term))

    ggplot(cox_df, aes(x = HR, y = term)) +
      geom_point(aes(color = ifelse(HR == 1, "Reference", "Estimated")), size = 5) +  # Different colors
      geom_errorbarh(data = cox_df %>% filter(HR != 1),
                     aes(xmin = lower_CI, xmax = upper_CI), height = 0.5, 
                     size = 1) +  # CI bars only for non-references
      geom_vline(xintercept = 1, linetype = "dashed", color = "red") +  # Reference line at HR = 1
      scale_x_log10() +  # Log scale for HR
      scale_color_manual(values = c("Reference" = "black", "Estimated" = "blue")) +  # Define colors
      labs(
        x = "Hazard Ratio (HR)",
        y = "",
        title = ""
      ) +
      theme_bw() +
      theme(
        axis.text.y = element_text(size = 18),
        axis.title.x = element_text(size = 18),
        legend.title = element_blank(),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(), 
      ) #1700 x 1600

#### Wald test for significance

    car::Anova(cox_psychotropic_WG, type = 3, test.statistic = "Wald")

#### Survival plot

    lw = 0.5
    ggsurvplot(survfit(cox_psychotropic_WG), 
               data = WeightGain_Exposed_3out5,
               conf.int = TRUE, 
               risk.table = TRUE, 
               ggtheme = theme_bw(),
               fontsize = 5, 
               font.x = 12, 
               font.tickslab = 12, 
               font.y = 12, 
               font.legend = 12, 
               axis.text = element_text(size = 14))

#### Forest plot - secondary

Here, we ran also other type of forest plot to visualize hazard ratios,
confidence interval, and significance value.

    #1400 * 750
    WeightGain_Exposed_3out5_forest <- WeightGain_Exposed_3out5 %>% 
      rename(
        `History of schizophrenia` = schizo_diagn_hist, 
        `Place of residence` = pat_region, 
        `Follow-up overlapping with event` = overlaps_event, 
        `Number of medication taken` = Num_MedTaken,
        `Medication setting` = `medication`, 
        `History of ID`= ID_diagn_hist, 
        `Duration of medication events` = duration_ByEvent,  
         `Sex` = der_sex, 
        `History of depression` = depressive_diagn_hist,
        `History of bipolar dis.`= bipolar_diagn_hist, 
        `History of anxiety`= anxiety_diagn_hist,  
        `Age at first medication event`= age_startFollowUp_group, 
        `History of ADHD` = ADHD_diagn_hist, 
        `Meds for sleep/insomnia` = sleep_insomnia, 
        `Meds for aggressive behavior` = aggr_behav, 
        `Meds for depressive/anxiety/OCD repetitive behaviors` = depress_anx_ocd_repet_behav, 
        `Meds for irritability` = irritability, 
        `Meds for antiseizure with some effects on behavior` = antiseizure_behav, 
        `Meds for ADHD` = adhd_meds, 
        `Meds for ADHD for aggression` = adhd_aggr
        # `Antipsychotics use` = antipsychotics_use, 
        # `SSRIs use` = SSRIs_use
    )
    # `Number of medication taken`
    cox_psychotropic_WG_2 <- coxph(Surv(tstart, tstop, fustat) ~  `Medication setting`+ `Follow-up overlapping with event` + `Duration of medication events` + `Meds for aggressive behavior` + `Meds for depressive/anxiety/OCD repetitive behaviors` + `Meds for irritability` + `Meds for antiseizure with some effects on behavior` +  `Meds for ADHD` + `Meds for ADHD for aggression` +`Meds for sleep/insomnia`  + `Sex` + `Place of residence` + `Age at first medication event` + `History of depression` + `History of anxiety` +  `History of bipolar dis.` + `History of schizophrenia` + `History of ADHD` + `History of ID`,
                              data = WeightGain_Exposed_3out5_forest)

    # + `Meds for aggressive behavior` + `Meds for depressive/anxiety/OCD repetitive behaviors` + `Meds for irritability` + `Meds for antiseizure with some effects on behavior` +  `Meds for ADHD` + `Meds for ADHD for aggression` 

    ggforest(cox_psychotropic_WG_2, data = WeightGain_Exposed_3out5_forest, fontsize = 1.05) #2500 * 1500

#### Table for sensitivity analysis - changing follow-up period

This is to generate the hazard ratios, confidence interal and
significance value for weight gain cohort when changing the follow-up
period for the sensitivity analysis.

    metabolic_syndrome_option <- "WG"

    summary_model <- summary(cox_psychotropic_WG_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]

    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      "Number of medication takenLow Polypharmacy",
      "Number of medication takenHigh Polypharmacy",
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", polypharmacy_select, ".csv"))

#### Table for sensitivity analysis - changing polypharmacy definition

    metabolic_syndrome_option <- "WG"


    summary_model <- summary(cox_psychotropic_WG_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]

    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      paste0("Medication settingPolypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Medication settingPolypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
       paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
       paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL

    # fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/FollowUp/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", polypharmacy_select, ".csv"))

#### Basehaz

Cumulative hazard stratified by medication

    # + antipsychotics_use + SSRIs_use
    cox_psychotropic_WG_strata <- coxph(Surv(tstart, tstop, fustat) ~ strata(Num_MedTaken) + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist,
                              data = WeightGain_Exposed_3out5)

    base_haz_strata <- basehaz(cox_psychotropic_WG_strata) 

    lw <- 0.5

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time (days)", y = "Cumulative hazard", color = "") + 
      scale_color_manual(values = c("Monotherapy" = "#EF520F", "Low Polypharmacy" = "#430384", "High Polypharmacy" = "#156884")) + 
      theme_bw(base_size = 22) + 
      theme(
        panel.border = element_rect(size = lw, colour = 'black'),
        axis.line = element_line(size = lw),
        axis.ticks = element_line(size = lw),
        axis.text = element_text(size = 14),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(),
        text = element_text(family = "Arial"), 
        legend.text = element_text(size = 21), 
        axis.text.x = element_text(size = 21), 
        axis.text.y = element_text(size = 21), 
        legend.title = element_text(face = "bold"), 
        legend.position = "bottom") #1050 * 700

Stratified by age groups

    cox_psychotropic_WG_strata <- coxph(Surv(tstart, tstop, fustat) ~ overlaps_event +  + der_sex + duration_ByEvent + Num_MedTaken + strata(age_startFollowUp_group) + pat_region + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist, 
                              data = WeightGain_Exposed_3out5)


    base_haz_strata <- basehaz(cox_psychotropic_WG_strata) 

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time", y = "Cumulative hazard") +  
      theme_bw(base_size = 22) 

#### Residual diagnosis

This residual diagnosis is to check the proportional hazards assumption
for time-fixed covariates with Schoenfeld Residuals. A p-value less than
0.05 suggests a violation of the proportional hazard assumption for that
covariate.

Observing the plot for each time-fixed covariate against time, the
residuals must display a random scatter around zero with no obvious
trend to the proportional hazard assumption holds.

    ph_test_WG <- cox.zph(cox_psychotropic_WG_2)
    print(ph_test_WG)

According with the p-value for each covariate and the global test we can
assume the proportional hazards for the time-fixed covariates. You can
also do a graphical diagnostic.

    p <- ggcoxzph(ph_test_WG)

#### Influential observations

To test influential observations or outliers, we can visualize either
the `deviance residuals` or the `dfbeta` values.

    ggcoxdiagnostics(cox_psychotropic_WG_2, type = "deviance", linear.predictions =  FALSE, ggtheme = theme_bw(base_size = 22)) + 
      labs(
        x = "Observations", 
        y = "Residuals"
      )

    deviance_resid_WG <- residuals(cox_psychotropic_WG_2, type = "deviance")
    threshold <- 2 

    num_outliers_WG <- sum(abs(deviance_resid_WG) > threshold) 

    proportion_outliers <- num_outliers_WG / length(deviance_resid_WG) * 100

    proportion_outliers

#### Multicollinearity test

##### Time-varying predictors

To evaluate the multicollinearity of time-varying predictors, we have to
divide the dataset into time intervals, and calculate the VID for
predictors within each time segment. Is multicollinearity changing
overtime?

    WeightGain_Exposed_3out5$medication <- as.factor(WeightGain_Exposed_3out5$medication)
    WeightGain_Exposed_3out5$overlaps_event <- as.factor(WeightGain_Exposed_3out5$overlaps_event)
    WeightGain_Exposed_3out5$der_sex <- as.factor(WeightGain_Exposed_3out5$der_sex)
    WeightGain_Exposed_3out5$duration_ByEvent <- as.factor(WeightGain_Exposed_3out5$duration_ByEvent)
    # WeightGain_Exposed_3out5$Num_MedTaken <- as.factor(WeightGain_Exposed_3out5$Num_MedTaken)
    WeightGain_Exposed_3out5$SSRIs_use <- as.factor(WeightGain_Exposed_3out5$SSRIs_use)
    WeightGain_Exposed_3out5$antipsychotics_use <- as.factor(WeightGain_Exposed_3out5$antipsychotics_use)
    WeightGain_Exposed_3out5$age_startFollowUp_group <- as.factor(WeightGain_Exposed_3out5$age_startFollowUp_group)
    WeightGain_Exposed_3out5$pat_region <- as.factor(WeightGain_Exposed_3out5$pat_region)
    WeightGain_Exposed_3out5$depressive_diagn_hist <- as.factor(WeightGain_Exposed_3out5$depressive_diagn_hist)
    WeightGain_Exposed_3out5$duration_ByEvent <- as.factor(WeightGain_Exposed_3out5$duration_ByEvent)
    WeightGain_Exposed_3out5$anxiety_diagn_hist <- as.factor(WeightGain_Exposed_3out5$anxiety_diagn_hist)
    WeightGain_Exposed_3out5$bipolar_diagn_hist <- as.factor(WeightGain_Exposed_3out5$bipolar_diagn_hist)
    WeightGain_Exposed_3out5$schizo_diagn_hist <- as.factor(WeightGain_Exposed_3out5$schizo_diagn_hist)
    WeightGain_Exposed_3out5$ADHD_diagn_hist <- as.factor(WeightGain_Exposed_3out5$ADHD_diagn_hist)
    WeightGain_Exposed_3out5$ID_diagn_hist <- as.factor(WeightGain_Exposed_3out5$ID_diagn_hist)

    WeightGain_Exposed_3out5$sleep_insomnia <- as.factor(WeightGain_Exposed_3out5$sleep_insomnia)
    WeightGain_Exposed_3out5$aggr_behav <- as.factor(WeightGain_Exposed_3out5$aggr_behav)
    WeightGain_Exposed_3out5$depress_anx_ocd_repet_behav <- as.factor(WeightGain_Exposed_3out5$depress_anx_ocd_repet_behav)
    WeightGain_Exposed_3out5$irritability <- as.factor(WeightGain_Exposed_3out5$irritability)
    WeightGain_Exposed_3out5$antiseizure_behav <- as.factor(WeightGain_Exposed_3out5$antiseizure_behav)
    WeightGain_Exposed_3out5$adhd_meds <- as.factor(WeightGain_Exposed_3out5$adhd_meds)
    WeightGain_Exposed_3out5$adhd_aggr <- as.factor(WeightGain_Exposed_3out5$adhd_aggr)


    vif(cox_psychotropic_WG)

If you look at the results of the VIF, there are two variables with a
VIF higher than 5, indicating high correlation. Because there are two of
them, we can conclude that medication and number of medication taken are
highly associated. However we can construct a correlation matrix called
Cramer’s V for categorical variables.

    #Select variables used in the model 
    #medication
    WeightGain_Exposed_3out5_v2 <- WeightGain_Exposed_3out5 %>% 
      select(Num_MedTaken, medication, overlaps_event, der_sex, duration_ByEvent, sleep_insomnia, aggr_behav, depress_anx_ocd_repet_behav,irritability, antiseizure_behav, adhd_meds, adhd_aggr, age_startFollowUp_group, pat_region, depressive_diagn_hist, anxiety_diagn_hist, bipolar_diagn_hist, schizo_diagn_hist, ADHD_diagn_hist, ID_diagn_hist)

    # function to get chi square p value and Cramers V
    f = function(x,y) {
      tbl = WeightGain_Exposed_3out5_v2 %>% dplyr::select(x,y) %>% table()
      chisq_pval = round(chisq.test(tbl)$p.value, 4)
      cramV = round(cramersV(tbl), 4)
      data.frame(x, y, chisq_pval, cramV) }

    # create unique combinations of column names

    # sorting will help getting a better plot (upper triangular)
    df_comb_WG = data.frame(t(combn(sort(names(WeightGain_Exposed_3out5_v2)), 2)), stringsAsFactors = F)

    # apply function to each variable combination
    df_res_WG = map2_df(df_comb_WG$X1, df_comb_WG$X2, f)

The following figure contains the p-value of the chi-square to test if
there is a significant association or not. It ranges from 0 (green
values) to 1 (red values). The number inside the color boxes are the
Cramer’s V value, a measure of association between two categorical
values, ranging from 0 to 1.

-   A Cramer’s V near to 1 (0.7 or above), indicates a strong
    association between the two variables, meaning that knowing the
    category of one variable gives substancial information about the
    other.

-   A Cramer’s V near to 0 indicates weak or negligible association
    (i.e., they are nearly independent)

-   Intermediate values, e.g., from 0.1 to 0.7, imply moderate
    association levels, where knowing one variable provides some
    information about the other, though not conclusively.

<!-- -->

    # new_labels_x <- c("schizo_diagn_hist" = "History of schizophrenia",
    #                   "pat_region" = "Place of residence", 
    #                   "overlaps_event" = "Follow-up overlapping with event", 
    #                   "Num_MedTaken" = "Number of medication taken", 
    #                   #"medication" = "Medication setting", 
    #                   "ID_diagn_hist" = "History of ID", 
    #                   "duration_ByEvent" = "Duration of medication events", 
    #                   "der_sex" = "Sex", 
    #                   "depressive_diagn_hist" = "History of depression", 
    #                   "bipolar_diagn_hist" = "History of bipolar dis.", 
    #                   "anxiety_diagn_hist" = "History of anxiety", 
    #                   "age_startFollowUp_group" = "Age at first medication event", 
    #                   "ADHD_diagn_hist" = "History of ADHD", 
    #                   "antipsychotics_use" = "Antipsychotics use", 
    #                   "SSRIs_use"="SSRIs use")

    new_labels_x <- c("schizo_diagn_hist" = "History of schizophrenia",
                      "pat_region" = "Place of residence", 
                      "overlaps_event" = "Follow-up overlapping with event", 
                      "Num_MedTaken" = "Number of medication taken", 
                      "medication" = "Medication setting", 
                      "ID_diagn_hist" = "History of ID", 
                      "duration_ByEvent" = "Duration of medication events", 
                      "der_sex" = "Sex", 
                      "depressive_diagn_hist" = "History of depression", 
                      "bipolar_diagn_hist" = "History of bipolar dis.", 
                      "anxiety_diagn_hist" = "History of anxiety", 
                      "age_startFollowUp_group" = "Age at first medication event", 
                      "ADHD_diagn_hist" = "History of ADHD", 
                      # "antipsychotics_use" = "Antipsychotics use", 
                      # "SSRIs_use"="SSRIs use", 
                      "sleep_insomnia" = "Meds for sleep/insomnia", 
                      "aggr_behav" = "Meds for aggressive behavior", 
                      "depress_anx_ocd_repet_behav" = "Meds for depressive/anxiety/OCD repetitive behaviors", 
                      "irritability" = "Meds for irritability", 
                      "antiseizure_behav" = "Meds for antiseizure with some effects on behavior", 
                      "adhd_meds" = "Meds for ADHD",
                      "adhd_aggr" = "Meds for ADHD for aggression")

    # plot results
    p1 <- df_res_WG %>%
      ggplot(aes(x,y,fill=cramV))+
      geom_tile()+
      geom_text(aes(x,y,label=cramV), size = 5)+
      scale_fill_gradient2(low="#92e2a6", mid = "white", high="#faaf90", midpoint = 0.2) +
      scale_x_discrete(labels = new_labels_x) + 
      scale_y_discrete(labels = new_labels_x) +
      theme_classic() + 
      labs(
        title = "Weight gain",
        x = "", 
        y = "", 
        fill = "Crammer's V"
      ) +
      theme(
        text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, hjust = 1)
      )

Looking at the results for the Cramer’s V, there only two variables with
a significant high correlation is medication taken and medication
setting.

Because number of medication taken brings more information, we decided
to exclude medication setting (polypharmacy, monotherapy).

## High cholesterol level

    metabolic_syndrome_related_diagn_Last <- metabolic_syndrome_related_diagn_Last %>% 
      mutate(PATIENT_ID = pat_id)


    HC_Exposed_3out5 <- Creation_df_ByCondition("High cholesterol level")

    # HC_Exposed_3out5 <- HC_Exposed_3out5 %>%
    #   mutate(
    #     SSRIs_use = if_else(SSRIs_use == "FALSE", "No", "Yes"), 
    #     antipsychotics_use = if_else(antipsychotics_use == "FALSE", "No", "Yes")
    #   )

    #Classification of medications according with intended use 
    HC_Exposed_3out5 <- HC_Exposed_3out5 %>%
    mutate(sleep_insomnia = if_else(sleep_insomnia == "FALSE", "No", "Yes"),
           aggr_behav = if_else(aggr_behav == "FALSE", "No", "Yes"), 
           depress_anx_ocd_repet_behav = if_else(depress_anx_ocd_repet_behav == "FALSE", "No", "Yes"), 
           irritability = if_else(irritability == "FALSE", "No", "Yes"),
           antiseizure_behav = if_else(antiseizure_behav == "FALSE", "No", "Yes"),
           adhd_meds = if_else(adhd_meds == "FALSE", "No", "Yes"),
           adhd_aggr = if_else(adhd_aggr == "FALSE", "No", "Yes")
           )

### Cox proportional hazard model

    # overlaps_event
    cox_psychotropic_HC <- coxph(Surv(tstart, tstop, fustat) ~  Num_MedTaken + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist,
                              data = HC_Exposed_3out5)

#### Forest plot for publication

    # Fit Cox model (assuming your model is already created)
    cox_model <- cox_psychotropic_HC

    # Extract hazard ratios (HR)
    cox_summary <- broom::tidy(cox_model, exponentiate = TRUE)

    # Extract confidence intervals separately
    conf_intervals <- confint(cox_model)
    conf_intervals <- exp(conf_intervals)  # Convert log HR to HR

    # Convert confidence intervals to a dataframe
    conf_df <- data.frame(term = rownames(conf_intervals),
                          lower_CI = conf_intervals[, 1],
                          upper_CI = conf_intervals[, 2])

    # Merge the two dataframes
    cox_df <- left_join(cox_summary, conf_df, by = "term")

    # Select relevant columns
    cox_df <- cox_df %>%
      select(term, estimate, lower_CI, upper_CI, p.value) %>%
      rename(HR = estimate)

    # Identify reference categories manually
    reference_rows <- data.frame(
      term = c("der_sexMale", "age_startFollowUp_groupReference", "pat_regionReference",
               "overlaps_eventRef","depressive_diagn_histRef", "anxiety_diagn_histRef",
               "bipolar_diagn_histRef", "schizo_diagn_histRef", "ADHD_diagn_histRef", 
               "ID_diagn_histRef", "duration_ByEventRef", "Num_MedTakenRef", "sleep_insomniaRef", "aggr_behavRef", "depress_anx_ocd_repet_behavRef", "irritabilityRef", "antiseizure_behavRef", "adhd_medsRef", "adhd_aggrRef"),
      HR = 1,  # Reference category HR is always 1
      lower_CI = 1,  # Reference confidence interval is also 1
      upper_CI = 1,
      p.value = NA  # p-value is not applicable for reference categories
    )

    #Names of the category
    caterogies_rows <- data.frame(
      term = c("sex", "age", "region",
               "overlaps","depression", "anxiety",
               "bipolar", "schizo", "adhd", 
               "id", "duration", "medications", "sleep_insomnia_class", "aggr_behav_class",
               "depress_anx_ocd_repet_behav_class", "irritability_class",
               "antiseizure_behav_class", 
               "adhd_meds_class", "adhd_aggr_class"),
      HR = NA,  # Reference category HR is always 1
      lower_CI = NA,  # Reference confidence interval is also 1
      upper_CI = NA,
      p.value = NA  # p-value is not applicable for reference categories
    )

    # Append reference categories to the cox_df
    cox_df <- bind_rows(cox_df, reference_rows)
    cox_df <- bind_rows(cox_df, caterogies_rows)


    cox_df[order(cox_df$term),]

    custom_order <- c(
      "medications", "Num_MedTakenRef", "Num_MedTakenLow Polypharmacy", "Num_MedTakenHigh Polypharmacy",
      "overlaps", "overlaps_eventRef", "overlaps_eventYes",
      "duration", "duration_ByEventRef", "duration_ByEventGreater than 365",
      "sleep_insomnia_class", "sleep_insomniaRef", "sleep_insomniaYes", 
      "aggr_behav_class", "aggr_behavRef", "aggr_behavYes", 
      "irritability_class", "irritabilityRef",  "irritabilityYes",
      "depress_anx_ocd_repet_behav_class", "depress_anx_ocd_repet_behavRef", "depress_anx_ocd_repet_behavYes", 
      "antiseizure_behav_class", "antiseizure_behavRef", "antiseizure_behavYes",
      "adhd_meds_class", "adhd_medsRef", "adhd_medsYes", 
      "adhd_aggr_class", "adhd_aggrRef", "adhd_aggrYes",
      # "ssris_used", "SSRIs_useRef", "SSRIs_useYes",
      # "aa_used", "antipsychotics_useRef", "antipsychotics_useYes",
      "sex","der_sexMale", "der_sexF", 
      "region", "pat_regionReference", "pat_regionE", "pat_regionS", "pat_regionW",
      "age", "age_startFollowUp_groupReference", "age_startFollowUp_groupAdolescence", "age_startFollowUp_groupEarly, Middle and Late Childhood",
      "depression", "depressive_diagn_histRef", "depressive_diagn_histYes",
      "anxiety", "anxiety_diagn_histRef", "anxiety_diagn_histYes",
      "bipolar","bipolar_diagn_histRef", "bipolar_diagn_histYes",
      "schizo", "schizo_diagn_histRef", "schizo_diagn_histYes",
      "adhd", "ADHD_diagn_histRef", "ADHD_diagn_histYes",
      "id", "ID_diagn_histRef", "ID_diagn_histYes"
    )

    cox_df$term <- factor(cox_df$term, levels = rev(custom_order))  # reversed so top = first

    cox_df <- cox_df %>% 
      filter(!is.na(term))

    ggplot(cox_df, aes(x = HR, y = term)) +
      geom_point(aes(color = ifelse(HR == 1, "Reference", "Estimated")), size = 5) +  # Different colors
      geom_errorbarh(data = cox_df %>% filter(HR != 1),
                     aes(xmin = lower_CI, xmax = upper_CI), height = 0.5, 
                     size = 1) +  # CI bars only for non-references
      geom_vline(xintercept = 1, linetype = "dashed", color = "red") +  # Reference line at HR = 1
      scale_x_log10() +  # Log scale for HR
      scale_color_manual(values = c("Reference" = "black", "Estimated" = "blue")) +  # Define colors
      labs(
        x = "Hazard Ratio (HR)",
        y = "",
        title = ""
      ) +
      theme_bw() +
      theme(
        axis.text.y = element_text(size = 18),
        axis.title.x = element_text(size = 18),
        legend.title = element_blank(),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(), 
      ) #1700 x 1600

#### Forest plot

    #1400 * 750
    HC_Exposed_3out5_forest <- HC_Exposed_3out5 %>% 
      rename(
        `History of schizophrenia` = schizo_diagn_hist, 
        `Place of residence` = pat_region, 
        `Follow-up overlapping with event` = overlaps_event, 
        `Number of medication taken` = Num_MedTaken,
        `Medication setting` = medication, 
        `History of ID`= ID_diagn_hist, 
        `Duration of medication events` = duration_ByEvent,  
         `Sex` = der_sex, 
        `History of depression` = depressive_diagn_hist,
        `History of bipolar dis.`= bipolar_diagn_hist, 
        `History of anxiety`= anxiety_diagn_hist, 
        `Age at first medication event`= age_startFollowUp_group, 
        `History of ADHD` = ADHD_diagn_hist, 
        `Meds for sleep/insomnia` = sleep_insomnia, 
        `Meds for aggressive behavior` = aggr_behav, 
        `Meds for depressive/anxiety/OCD repetitive behaviors` = depress_anx_ocd_repet_behav, 
        `Meds for irritability` = irritability, 
        `Meds for antiseizure with some effects on behavior` = antiseizure_behav, 
        `Meds for ADHD` = adhd_meds, 
        `Meds for ADHD for aggression` = adhd_aggr
        # `Antipsychotics use` = antipsychotics_use, 
        # `SSRIs use` = SSRIs_use
    )

    #`Number of medication taken`
    cox_psychotropic_HC_2 <- coxph(Surv(tstart, tstop, fustat) ~  `Medication setting` + `Follow-up overlapping with event` + `Duration of medication events` + `Meds for aggressive behavior` + `Meds for depressive/anxiety/OCD repetitive behaviors` + `Meds for irritability` + `Meds for antiseizure with some effects on behavior` +  `Meds for ADHD` + `Meds for ADHD for aggression` + `Meds for sleep/insomnia` + `Sex` + `Place of residence` + `Age at first medication event` + `History of depression` + `History of anxiety` +  `History of bipolar dis.` + `History of schizophrenia` + `History of ADHD` + `History of ID`,
                                   data = HC_Exposed_3out5_forest)

    ggforest(cox_psychotropic_HC_2, data = HC_Exposed_3out5_forest, fontsize = 1.2) #1400 * 750

#### Table for sensitivity analysis - changing follow-up period

    metabolic_syndrome_option <- "HC"

    summary_model <- summary(cox_psychotropic_HC_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]

    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      "Number of medication takenLow Polypharmacy",
      "Number of medication takenHigh Polypharmacy",
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL

    # fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/FollowUp/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

#### Table for sensitivity analysis - changing polypharmacy definition

    metabolic_syndrome_option <- "HC"

    summary_model <- summary(cox_psychotropic_HC_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]

    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      paste0("Medication settingPolypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Medication settingPolypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
       paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
       paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL

    # fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/FollowUp/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", polypharmacy_select, ".csv"))

#### BaseHaz

Stratified by polypharmacy.

    #overlaps_event + 
    cox_psychotropic_HC_strata <- coxph(Surv(tstart, tstop, fustat) ~ strata(Num_MedTaken) + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist, 
                              data = HC_Exposed_3out5)


    base_haz_strata <- basehaz(cox_psychotropic_HC_strata) 

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time (days)", y = "Cumulative hazard", color = "") + 
      scale_color_manual(values = c("Monotherapy" = "#EF520F", "Low Polypharmacy" = "#430384", "High Polypharmacy" = "#156884")) + 
      theme_bw(base_size = 22) + 
      theme(
        panel.border = element_rect(size = lw, colour = 'black'),
        axis.line = element_line(size = lw),
        axis.ticks = element_line(size = lw),
        axis.text = element_text(size = 14),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(),
        legend.text = element_text(size = 21), 
        axis.text.x = element_text(size = 21), 
        axis.text.y = element_text(size = 21), 
        legend.title = element_text(face = "bold"), 
        legend.position = "bottom")

    #WG_cumulativeHaz_Poly

By age group.

    cox_psychotropic_HC_strata <- coxph(Surv(tstart, tstop, fustat) ~  overlaps_event + der_sex + duration_ByEvent +  Num_MedTaken + strata(age_startFollowUp_group) + pat_region + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist, 
                              data = HC_Exposed_3out5)


    base_haz_strata <- basehaz(cox_psychotropic_HC_strata) 

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time", y = "Cumulative hazard") +  
      theme_bw(base_size = 22) 

#### Residual diagnosis

This residual diagnosis is to check the proportional hazards assumption
for time-fixed covariates with Schoenfeld Residuals. A p-value less than
0.05 suggests a violation of the proportional hazard assumption for that
covariate.

Observing the plot for each time-fixed covariate against time, the
residuals must display a random scatter around zero with no obvious
trend to the proportional hazard assumption holds.

    ph_test_HC <- cox.zph(cox_psychotropic_HC)
    print(ph_test_HC)

According with the p-value for each covariate and the global test we can
assume the proportional hazards for the time-fixed covariates. You can
also do a graphical diagnostic.

    ggcoxzph(ph_test_HC)

#### Influential observations

To test influential observations or outliers, we can visualize either
the `deviance residuals` or the `dfbeta` values.

    ggcoxdiagnostics(cox_psychotropic_HC, type = "deviance", linear.predictions =  FALSE, ggtheme = theme_bw(base_size = 22)) + 
      labs(
        x = "Observations", 
        y = "Residuals"
      )

    deviance_resid_HC <- residuals(cox_psychotropic_HC, type = "deviance")
    threshold <- 2 

    num_outliers_HC <- sum(abs(deviance_resid_HC) > threshold) 

    proportion_outliers <- num_outliers_HC / length(deviance_resid_HC) * 100

#### Multicollinearity test

##### Time-varying predictors

To evaluate the multicollinearity of time-varying predictors, we have to
divide the dataset into time intervals, and calculate the VID for
predictors within each time segment. Is multicollinearity changing
overtime?

    HC_Exposed_3out5$medication <- as.factor(HC_Exposed_3out5$medication)
    HC_Exposed_3out5$overlaps_event <- as.factor(HC_Exposed_3out5$overlaps_event)
    HC_Exposed_3out5$der_sex <- as.factor(HC_Exposed_3out5$der_sex)
    HC_Exposed_3out5$duration_ByEvent <- as.factor(HC_Exposed_3out5$duration_ByEvent)
    HC_Exposed_3out5$Num_MedTaken <- as.factor(HC_Exposed_3out5$Num_MedTaken)
    HC_Exposed_3out5$age_startFollowUp_group <- as.factor(HC_Exposed_3out5$age_startFollowUp_group)
    HC_Exposed_3out5$pat_region <- as.factor(HC_Exposed_3out5$pat_region)
    HC_Exposed_3out5$depressive_diagn_hist <- as.factor(HC_Exposed_3out5$depressive_diagn_hist)
    HC_Exposed_3out5$duration_ByEvent <- as.factor(HC_Exposed_3out5$duration_ByEvent)
    HC_Exposed_3out5$anxiety_diagn_hist <- as.factor(HC_Exposed_3out5$anxiety_diagn_hist)
    HC_Exposed_3out5$bipolar_diagn_hist <- as.factor(HC_Exposed_3out5$bipolar_diagn_hist)
    HC_Exposed_3out5$schizo_diagn_hist <- as.factor(HC_Exposed_3out5$schizo_diagn_hist)
    HC_Exposed_3out5$ADHD_diagn_hist <- as.factor(HC_Exposed_3out5$ADHD_diagn_hist)
    HC_Exposed_3out5$ID_diagn_hist <- as.factor(HC_Exposed_3out5$ID_diagn_hist)


    vif(cox_psychotropic_HC)

If you look at the results of the VIF, there are two variables with a
VIF higher than 5, indicating high correlation. Because there are two of
them, we can conclude that medication and number of medication taken are
highly associated. However we can construct a correlation matrix called
Cramer’s V for categorical variables.

    #Select variables used in the model 
    HC_Exposed_3out5_v2 <- HC_Exposed_3out5 %>% 
      select(Num_MedTaken, overlaps_event, der_sex, duration_ByEvent, sleep_insomnia, aggr_behav, depress_anx_ocd_repet_behav,irritability, antiseizure_behav, adhd_meds, adhd_aggr, age_startFollowUp_group, pat_region, depressive_diagn_hist, anxiety_diagn_hist, bipolar_diagn_hist, schizo_diagn_hist, ADHD_diagn_hist, ID_diagn_hist)

    # function to get chi square p value and Cramers V
    f = function(x,y) {
      tbl = HC_Exposed_3out5_v2 %>% dplyr::select(x,y) %>% table()
      chisq_pval = round(chisq.test(tbl)$p.value, 4)
      cramV = round(cramersV(tbl), 4)
      data.frame(x, y, chisq_pval, cramV) }

    # create unique combinations of column names

    # sorting will help getting a better plot (upper triangular)
    df_comb_HC = data.frame(t(combn(sort(names(HC_Exposed_3out5_v2)), 2)), stringsAsFactors = F)

    # apply function to each variable combination
    df_res_HC = map2_df(df_comb_HC$X1, df_comb_HC$X2, f)

The following figure contains the p-value of the chi-square to test if
there is a significant association or not. It ranges from 0 (green
values) to 1 (red values). The number inside the color boxes are the
Cramer’s V value, a measure of association between two categorical
values, ranging from 0 to 1 (Refer to same section Weight gain cohort
for more information).

    new_labels_x <- c("schizo_diagn_hist" = "History of schizophrenia",
                      "pat_region" = "Place of residence", 
                      "overlaps_event" = "Follow-up overlapping with event", 
                      "Num_MedTaken" = "Number of medication taken", 
                      #"medication" = "Medication setting", 
                      "ID_diagn_hist" = "History of ID", 
                      "duration_ByEvent" = "Duration of medication events", 
                      "der_sex" = "Sex", 
                      "depressive_diagn_hist" = "History of depression", 
                      "bipolar_diagn_hist" = "History of bipolar dis.", 
                      "anxiety_diagn_hist" = "History of anxiety", 
                      "age_startFollowUp_group" = "Age at first medication event", 
                      "ADHD_diagn_hist" = "History of ADHD", 
                      # "antipsychotics_use" = "Antipsychotics use", 
                      # "SSRIs_use"="SSRIs use", 
                      "sleep_insomnia" = "Meds for sleep/insomnia", 
                      "aggr_behav" = "Meds for aggressive behavior", 
                      "depress_anx_ocd_repet_behav" = "Meds for depressive/anxiety/OCD repetitive behaviors", 
                      "irritability" = "Meds for irritability", 
                      "antiseizure_behav" = "Meds for antiseizure with some effects on behavior", 
                      "adhd_meds" = "Meds for ADHD",
                      "adhd_aggr" = "Meds for ADHD for aggression")

    # plot results
    p2 <- df_res_HC %>%
      ggplot(aes(x,y,fill=cramV))+
      geom_tile()+
      geom_text(aes(x,y,label=cramV), size = 5)+
      scale_fill_gradient2(low="#92e2a6", mid = "white", high="#faaf90", midpoint = 0.2) +
      scale_x_discrete(labels = new_labels_x) + 
      scale_y_discrete(labels = new_labels_x) +
      theme_classic() + 
      labs(
        title = "High LDL cholesterol level",
        x = "", 
        y = "", 
        fill = "Crammer's V"
      ) +
      theme(
        text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, hjust = 1)
      )

Looking at the results for the Cramer’s V, there only two variables with
a significant high correlation is medication taken and medication
setting, as happened with the weight gain model.

Because number of medication taken brings more information, we decided
to exclude medication setting (polypharmacy, monotherapy).

## High blood sugar levels

    metabolic_syndrome_related_diagn_Last <- metabolic_syndrome_related_diagn_Last %>% 
      mutate(PATIENT_ID = pat_id)

    HBS_Exposed_3out5 <- Creation_df_ByCondition("High blood sugar")

    #Classification of medications according with intended use 
    HBS_Exposed_3out5 <- HBS_Exposed_3out5 %>%
    mutate(sleep_insomnia = if_else(sleep_insomnia == "FALSE", "No", "Yes"),
           aggr_behav = if_else(aggr_behav == "FALSE", "No", "Yes"), 
           depress_anx_ocd_repet_behav = if_else(depress_anx_ocd_repet_behav == "FALSE", "No", "Yes"), 
           irritability = if_else(irritability == "FALSE", "No", "Yes"),
           antiseizure_behav = if_else(antiseizure_behav == "FALSE", "No", "Yes"),
           adhd_meds = if_else(adhd_meds == "FALSE", "No", "Yes"),
           adhd_aggr = if_else(adhd_aggr == "FALSE", "No", "Yes")
           )

### Cox proportional hazard model

    cox_psychotropic_HBS <- coxph(Surv(tstart, tstop, fustat) ~  Num_MedTaken + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist,
                              data = HBS_Exposed_3out5)


    summary(cox_psychotropic_HBS)

#### Forest plot for publication

    # Fit Cox model (assuming your model is already created)
    cox_model <- cox_psychotropic_HBS


    # Extract hazard ratios (HR)
    cox_summary <- broom::tidy(cox_model, exponentiate = TRUE)

    # Extract confidence intervals separately
    conf_intervals <- confint(cox_model)
    conf_intervals <- exp(conf_intervals)  # Convert log HR to HR

    # Convert confidence intervals to a dataframe
    conf_df <- data.frame(term = rownames(conf_intervals),
                          lower_CI = conf_intervals[, 1],
                          upper_CI = conf_intervals[, 2])

    # Merge the two dataframes
    cox_df <- left_join(cox_summary, conf_df, by = "term")

    # Select relevant columns
    cox_df <- cox_df %>%
      select(term, estimate, lower_CI, upper_CI, p.value) %>%
      rename(HR = estimate)

    # Identify reference categories manually
    reference_rows <- data.frame(
      term = c("der_sexMale", "age_startFollowUp_groupReference", "pat_regionReference",
               "overlaps_eventRef","depressive_diagn_histRef", "anxiety_diagn_histRef",
               "bipolar_diagn_histRef", "schizo_diagn_histRef", "ADHD_diagn_histRef", 
               "ID_diagn_histRef", "duration_ByEventRef", "Num_MedTakenRef", "sleep_insomniaRef", "aggr_behavRef", "depress_anx_ocd_repet_behavRef", "irritabilityRef", "antiseizure_behavRef", "adhd_medsRef", "adhd_aggrRef"),
      HR = 1,  # Reference category HR is always 1
      lower_CI = 1,  # Reference confidence interval is also 1
      upper_CI = 1,
      p.value = NA  # p-value is not applicable for reference categories
    )

    #Names of the category
    caterogies_rows <- data.frame(
      term = c("sex", "age", "region",
               "overlaps","depression", "anxiety",
               "bipolar", "schizo", "adhd", 
               "id", "duration", "medications", "sleep_insomnia_class", "aggr_behav_class",
               "depress_anx_ocd_repet_behav_class", "irritability_class",
               "antiseizure_behav_class", 
               "adhd_meds_class", "adhd_aggr_class"),
      HR = NA,  # Reference category HR is always 1
      lower_CI = NA,  # Reference confidence interval is also 1
      upper_CI = NA,
      p.value = NA  # p-value is not applicable for reference categories
    )

    # Append reference categories to the cox_df
    cox_df <- bind_rows(cox_df, reference_rows)
    cox_df <- bind_rows(cox_df, caterogies_rows)


    cox_df[order(cox_df$term),]

    custom_order <- c(
      "medications", "Num_MedTakenRef", "Num_MedTakenLow Polypharmacy", "Num_MedTakenHigh Polypharmacy",
      "overlaps", "overlaps_eventRef", "overlaps_eventYes",
      "duration", "duration_ByEventRef", "duration_ByEventGreater than 365",
      "sleep_insomnia_class", "sleep_insomniaRef", "sleep_insomniaYes", 
      "aggr_behav_class", "aggr_behavRef", "aggr_behavYes", 
      "irritability_class", "irritabilityRef",  "irritabilityYes",
      "depress_anx_ocd_repet_behav_class", "depress_anx_ocd_repet_behavRef", "depress_anx_ocd_repet_behavYes", 
      "antiseizure_behav_class", "antiseizure_behavRef", "antiseizure_behavYes",
      "adhd_meds_class", "adhd_medsRef", "adhd_medsYes", 
      "adhd_aggr_class", "adhd_aggrRef", "adhd_aggrYes",
      # "ssris_used", "SSRIs_useRef", "SSRIs_useYes",
      # "aa_used", "antipsychotics_useRef", "antipsychotics_useYes",
      "sex","der_sexMale", "der_sexF", 
      "region", "pat_regionReference", "pat_regionE", "pat_regionS", "pat_regionW",
      "age", "age_startFollowUp_groupReference", "age_startFollowUp_groupAdolescence", "age_startFollowUp_groupEarly, Middle and Late Childhood",
      "depression", "depressive_diagn_histRef", "depressive_diagn_histYes",
      "anxiety", "anxiety_diagn_histRef", "anxiety_diagn_histYes",
      "bipolar","bipolar_diagn_histRef", "bipolar_diagn_histYes",
      "schizo", "schizo_diagn_histRef", "schizo_diagn_histYes",
      "adhd", "ADHD_diagn_histRef", "ADHD_diagn_histYes",
      "id", "ID_diagn_histRef", "ID_diagn_histYes"
    )

    cox_df$term <- factor(cox_df$term, levels = rev(custom_order))  # reversed so top = first

    cox_df <- cox_df %>% 
      filter(!is.na(term))

    ggplot(cox_df, aes(x = HR, y = term)) +
      geom_point(aes(color = ifelse(HR == 1, "Reference", "Estimated")), size = 5) +  # Different colors
      geom_errorbarh(data = cox_df %>% filter(HR != 1),
                     aes(xmin = lower_CI, xmax = upper_CI), height = 0.5, 
                     size = 1) +  # CI bars only for non-references
      geom_vline(xintercept = 1, linetype = "dashed", color = "red") +  # Reference line at HR = 1
      scale_x_log10() +  # Log scale for HR
      scale_color_manual(values = c("Reference" = "black", "Estimated" = "blue")) +  # Define colors
      labs(
        x = "Hazard Ratio (HR)",
        y = "",
        title = ""
      ) +
      theme_bw() +
      theme(
        axis.text.y = element_text(size = 18),
        axis.title.x = element_text(size = 18),
        legend.title = element_blank(),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(), 
      ) #1700 x 1600

#### Wald test for significance

    car::Anova(cox_psychotropic_HBS, type = 3, test.statistic = "Wald")

#### Survival plot

    ggsurvplot(survfit(cox_psychotropic_HBS), data = HBS_Exposed_3out5, 
               conf.int = TRUE, risk.table = TRUE, ggtheme = theme_bw(), 
               fontsize = 5, font.x = 12, font.tickslab = 12, font.y = 12, font.legend = 12)

#### Forest plot - sjPlot

    CI <- exp(confint(cox_psychotropic_HBS))

    set_theme(
      base = theme_classic(base_size = 22)
    )


    sjPlot::plot_model(cox_psychotropic_HBS, 
                       axis.lim = c(min(CI), max(CI)), 
                       show.p =  TRUE, 
                       dot.size = 5, 
                       line.size = 1.5,
                       value.offset = 0.05, 
                       show.legend = TRUE,
                       colors = c("#430384", "#EF520F")) #1700 * 800

#### Forest plot

    #1400 * 750
    HBS_Exposed_3out5_forest <- HBS_Exposed_3out5 %>% 
      rename(
        `History of schizophrenia` = schizo_diagn_hist, 
        `Place of residence` = pat_region, 
        `Follow-up overlapping with event` = overlaps_event, 
        `Number of medication taken` = Num_MedTaken,
        `Medication setting` = medication, 
        `History of ID`= ID_diagn_hist, 
        `Duration of medication events` = duration_ByEvent,  
         `Sex` = der_sex, 
        `History of depression` = depressive_diagn_hist,
        `History of bipolar dis.`= bipolar_diagn_hist, 
        `History of anxiety`= anxiety_diagn_hist, 
        `Age at first medication event`= age_startFollowUp_group, 
        `History of ADHD` = ADHD_diagn_hist, 
        `Meds for sleep/insomnia` = sleep_insomnia, 
        `Meds for aggressive behavior` = aggr_behav, 
        `Meds for depressive/anxiety/OCD repetitive behaviors` = depress_anx_ocd_repet_behav, 
        `Meds for irritability` = irritability, 
        `Meds for antiseizure with some effects on behavior` = antiseizure_behav, 
        `Meds for ADHD` = adhd_meds, 
        `Meds for ADHD for aggression` = adhd_aggr
        # `Antipsychotics use` = antipsychotics_use, 
        # `SSRIs use` = SSRIs_use
    )


    #`Number of medication taken`
    cox_psychotropic_HBS_2 <- coxph(Surv(tstart, tstop, fustat) ~  `Medication setting` + `Follow-up overlapping with event` + `Duration of medication events` + `Meds for aggressive behavior` + `Meds for depressive/anxiety/OCD repetitive behaviors` + `Meds for irritability` + `Meds for antiseizure with some effects on behavior` +  `Meds for ADHD` + `Meds for ADHD for aggression` + `Meds for sleep/insomnia` + `Sex` + `Place of residence` + `Age at first medication event` + `History of depression` + `History of anxiety` +  `History of bipolar dis.` + `History of schizophrenia` + `History of ADHD` + `History of ID`,
                                   data = HBS_Exposed_3out5_forest)

    ggforest(cox_psychotropic_HBS_2, data = HBS_Exposed_3out5_forest, fontsize = 1.2) #3000 x 2000

    # `Meds for sleep/insomnia` + `Meds for aggressive behavior` + `Meds for depressive/anxiety/OCD repetitive behaviors` + `Meds for irritability` + `Meds for antiseizure with some effects on behavior` +  `Meds for ADHD` + `Meds for ADHD for aggression` +

    # ggforest(cox_psychotropic_HBS, data = HBS_Exposed_3out5, fontsize = 0.55) #1400 * 750

#### Table for sensitivity analysis - changing polypharmacy definition

    metabolic_syndrome_option <- "HBS"

    summary_model <- summary(cox_psychotropic_HBS_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]

    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      paste0("Medication settingPolypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Medication settingPolypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
       paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
       paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL

    # fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/FollowUp/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", polypharmacy_select, ".csv"))

#### Table for sensitivity analysis - changing follow-up period

    metabolic_syndrome_option <- "HBS"

    summary_model <- summary(cox_psychotropic_HBS_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]

    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      "Number of medication takenLow Polypharmacy",
      "Number of medication takenHigh Polypharmacy",
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL
    # 
    # fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/FollowUp/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", polypharmacy_select, ".csv"))

#### Basehaz

Cumulative hazard stratified by medication

    # overlaps_event
    cox_psychotropic_HBS_strata <- coxph(Surv(tstart, tstop, fustat) ~ strata(Num_MedTaken) + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist,  
                              data = HBS_Exposed_3out5)


    base_haz_strata <- basehaz(cox_psychotropic_HBS_strata) 

    lw <- 0.5

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time (days)", y = "Cumulative hazard", color = "") + 
      scale_color_manual(values = c("Monotherapy" = "#EF520F", "Low Polypharmacy" = "#430384", "High Polypharmacy" = "#156884")) + 
      theme_bw(base_size = 22) + 
      theme(
        panel.border = element_rect(size = lw, colour = 'black'),
        axis.line = element_line(size = lw),
        axis.ticks = element_line(size = lw),
        axis.text = element_text(size = 14),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(),
        legend.text = element_text(size = 21), 
        axis.text.x = element_text(size = 21), 
        axis.text.y = element_text(size = 21), 
        legend.title = element_text(face = "bold"), 
        legend.position = "bottom")

Stratified by age groups

    cox_psychotropic_HBS_strata <- coxph(Surv(tstart, tstop, fustat) ~ medication + overlaps_event + der_sex + duration_ByEvent + Num_MedTaken + strata(age_startFollowUp_group) + pat_region + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist, 
                              data = HBS_Exposed_3out5)



    base_haz_strata <- basehaz(cox_psychotropic_HBS_strata) 

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time", y = "Cumulative hazard") +  
      theme_bw(base_size = 22) 

#### Residual diagnosis

This residual diagnosis is to check the proportional hazards assumption
for time-fixed covariates with Schoenfeld Residuals. A p-value less than
0.05 suggests a violation of the proportional hazard assumption for that
covariate.

Observing the plot for each time-fixed covariate against time, the
residuals must display a random scatter around zero with no obvious
trend to the proportional hazard assumption holds.

    ph_test_HBS <- cox.zph(cox_psychotropic_HBS)
    print(ph_test_HBS)

According with the p-value for each covariate and the global test we can
assume the proportional hazards for the time-fixed covariates. You can
also do a graphical diagnostic.

    ggcoxzph(ph_test_HBS)

#### Influential observations

To test influential observations or outliers, we can visualize either
the `deviance residuals` or the `dfbeta` values.

    ggcoxdiagnostics(cox_psychotropic_HBS, type = "deviance", linear.predictions =  FALSE, ggtheme = theme_bw(base_size = 22))

    deviance_resid_BS <- residuals(cox_psychotropic_HBS, type = "deviance")
    threshold <- 2 

    num_outliers_BS <- sum(abs(deviance_resid_BS) > threshold) 

    proportion_outliers <- num_outliers_BS / length(deviance_resid_BS) * 100

#### Multicollinearity test

##### Time-varying predictors

To evaluate the multicollinearity of time-varying predictors, we have to
divide the dataset into time intervals, and calculate the VID for
predictors within each time segment. Is multicollinearity changing
overtime?

    HBS_Exposed_3out5$medication <- as.factor(HBS_Exposed_3out5$medication)
    HBS_Exposed_3out5$overlaps_event <- as.factor(HBS_Exposed_3out5$overlaps_event)
    HBS_Exposed_3out5$der_sex <- as.factor(HBS_Exposed_3out5$der_sex)
    HBS_Exposed_3out5$duration_ByEvent <- as.factor(HBS_Exposed_3out5$duration_ByEvent)
    HBS_Exposed_3out5$Num_MedTaken <- as.factor(HBS_Exposed_3out5$Num_MedTaken)
    HBS_Exposed_3out5$age_startFollowUp_group <- as.factor(HBS_Exposed_3out5$age_startFollowUp_group)
    HBS_Exposed_3out5$pat_region <- as.factor(HBS_Exposed_3out5$pat_region)
    HBS_Exposed_3out5$depressive_diagn_hist <- as.factor(HBS_Exposed_3out5$depressive_diagn_hist)
    HBS_Exposed_3out5$duration_ByEvent <- as.factor(HBS_Exposed_3out5$duration_ByEvent)
    HBS_Exposed_3out5$anxiety_diagn_hist <- as.factor(HBS_Exposed_3out5$anxiety_diagn_hist)
    HBS_Exposed_3out5$bipolar_diagn_hist <- as.factor(HBS_Exposed_3out5$bipolar_diagn_hist)
    HBS_Exposed_3out5$schizo_diagn_hist <- as.factor(HBS_Exposed_3out5$schizo_diagn_hist)
    HBS_Exposed_3out5$ADHD_diagn_hist <- as.factor(HBS_Exposed_3out5$ADHD_diagn_hist)
    HBS_Exposed_3out5$ID_diagn_hist <- as.factor(HBS_Exposed_3out5$ID_diagn_hist)


    vif(cox_psychotropic_HBS)

If you look at the results of the VIF, there are two variables with a
VIF higher than 5, indicating high correlation. Because there are two of
them, we can conclude that medication and number of medication taken are
highly associated. However we can construct a correlation matrix called
Cramer’s V for categorical variables.

    #Select variables used in the model 
    HBS_Exposed_3out5_v2 <- HBS_Exposed_3out5 %>% 
      select(Num_MedTaken, overlaps_event, der_sex, duration_ByEvent, sleep_insomnia, aggr_behav, depress_anx_ocd_repet_behav,irritability, antiseizure_behav, adhd_meds, adhd_aggr, age_startFollowUp_group, pat_region, depressive_diagn_hist, anxiety_diagn_hist, bipolar_diagn_hist, schizo_diagn_hist, ADHD_diagn_hist, ID_diagn_hist)

    # function to get chi square p value and Cramers V
    f = function(x,y) {
      tbl = HBS_Exposed_3out5_v2 %>% dplyr::select(x,y) %>% table()
      chisq_pval = round(chisq.test(tbl)$p.value, 4)
      cramV = round(cramersV(tbl), 4)
      data.frame(x, y, chisq_pval, cramV) }

    # create unique combinations of column names

    # sorting will help getting a better plot (upper triangular)
    df_comb_HBS = data.frame(t(combn(sort(names(HBS_Exposed_3out5_v2)), 2)), stringsAsFactors = F)

    # apply function to each variable combination
    df_res_HBS = map2_df(df_comb_HBS$X1, df_comb_HBS$X2, f)

The following figure contains the p-value of the chi-square to test if
there is a significant association or not. It ranges from 0 (green
values) to 1 (red values). The number inside the color boxes are the
Cramer’s V value, a measure of association between two categorical
values, ranging from 0 to 1.

-   A Cramer’s V near to 1 (0.7 or above), indicates a strong
    association between the two variables, meaning that knowing the
    category of one variable gives substancial information about the
    other.

-   A Cramer’s V near to 0 indicates weak or negligible association
    (i.e., they are nearly independent)

-   Intermediate values, e.g., from 0.1 to 0.7, imply moderate
    association levels, where knowing one variable provides some
    information about the other, though not conclusively.

<!-- -->

    new_labels_x <- c("schizo_diagn_hist" = "History of schizophrenia",
                      "pat_region" = "Place of residence", 
                      "overlaps_event" = "Follow-up overlapping with event", 
                      "Num_MedTaken" = "Number of medication taken", 
                      #"medication" = "Medication setting", 
                      "ID_diagn_hist" = "History of ID", 
                      "duration_ByEvent" = "Duration of medication events", 
                      "der_sex" = "Sex", 
                      "depressive_diagn_hist" = "History of depression", 
                      "bipolar_diagn_hist" = "History of bipolar dis.", 
                      "anxiety_diagn_hist" = "History of anxiety", 
                      "age_startFollowUp_group" = "Age at first medication event", 
                      "ADHD_diagn_hist" = "History of ADHD", 
                      # "antipsychotics_use" = "Antipsychotics use", 
                      # "SSRIs_use"="SSRIs use", 
                      "sleep_insomnia" = "Meds for sleep/insomnia", 
                      "aggr_behav" = "Meds for aggressive behavior", 
                      "depress_anx_ocd_repet_behav" = "Meds for depressive/anxiety/OCD repetitive behaviors", 
                      "irritability" = "Meds for irritability", 
                      "antiseizure_behav" = "Meds for antiseizure with some effects on behavior", 
                      "adhd_meds" = "Meds for ADHD",
                      "adhd_aggr" = "Meds for ADHD for aggression")
    # plot results
    p4 <- df_res_HBS %>%
      ggplot(aes(x,y,fill=cramV))+
      geom_tile()+
      geom_text(aes(x,y,label=cramV), size = 5)+
      scale_fill_gradient2(low="#92e2a6", mid = "white", high="#faaf90", midpoint = 0.2) +
      scale_x_discrete(labels = new_labels_x) + 
      scale_y_discrete(labels = new_labels_x) +
      theme_classic() + 
      labs(
        title = "High blood sugar levels",
        x = "", 
        y = "", 
        fill = "Crammer's V"
      ) +
      theme(
        text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, hjust = 1)
      )

Looking at the results for the Cramer’s V, there only two variables with
a significant high correlation is medication taken and medication
setting.

Because number of medication taken brings more information, we decided
to exclude medication setting (polypharmacy, monotherapy).

## Hypertension

    metabolic_syndrome_related_diagn_Last <- metabolic_syndrome_related_diagn_Last %>% 
      mutate(PATIENT_ID = pat_id)

    HyT_Exposed_3out5 <- Creation_df_ByCondition("Hypertension")


    #Classification of medications according with intended use 
    HyT_Exposed_3out5 <- HyT_Exposed_3out5 %>%
    mutate(sleep_insomnia = if_else(sleep_insomnia == "FALSE", "No", "Yes"),
           aggr_behav = if_else(aggr_behav == "FALSE", "No", "Yes"), 
           depress_anx_ocd_repet_behav = if_else(depress_anx_ocd_repet_behav == "FALSE", "No", "Yes"), 
           irritability = if_else(irritability == "FALSE", "No", "Yes"),
           antiseizure_behav = if_else(antiseizure_behav == "FALSE", "No", "Yes"),
           adhd_meds = if_else(adhd_meds == "FALSE", "No", "Yes"),
           adhd_aggr = if_else(adhd_aggr == "FALSE", "No", "Yes")
           )

### Cox proportional hazard model

    cox_psychotropic_HyT <- coxph(Surv(tstart, tstop, fustat) ~  Num_MedTaken + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist,
                              data = HyT_Exposed_3out5)

    summary(cox_psychotropic_HyT)

#### Forest plot for publication

    #Fit Cox model (assuming your model is already created)
    cox_model <- cox_psychotropic_HyT


    # Extract hazard ratios (HR)
    cox_summary <- broom::tidy(cox_model, exponentiate = TRUE)

    # Extract confidence intervals separately
    conf_intervals <- confint(cox_model)
    conf_intervals <- exp(conf_intervals)  # Convert log HR to HR

    # Convert confidence intervals to a dataframe
    conf_df <- data.frame(term = rownames(conf_intervals),
                          lower_CI = conf_intervals[, 1],
                          upper_CI = conf_intervals[, 2])

    # Merge the two dataframes
    cox_df <- left_join(cox_summary, conf_df, by = "term")

    # Select relevant columns
    cox_df <- cox_df %>%
      select(term, estimate, lower_CI, upper_CI, p.value) %>%
      rename(HR = estimate)

    # Identify reference categories manually
    reference_rows <- data.frame(
      term = c("der_sexMale", "age_startFollowUp_groupReference", "pat_regionReference",
               "overlaps_eventRef","depressive_diagn_histRef", "anxiety_diagn_histRef",
               "bipolar_diagn_histRef", "schizo_diagn_histRef", "ADHD_diagn_histRef", 
               "ID_diagn_histRef", "duration_ByEventRef", "Num_MedTakenRef", "sleep_insomniaRef", "aggr_behavRef", "depress_anx_ocd_repet_behavRef", "irritabilityRef", "antiseizure_behavRef", "adhd_medsRef", "adhd_aggrRef"),
      HR = 1,  # Reference category HR is always 1
      lower_CI = 1,  # Reference confidence interval is also 1
      upper_CI = 1,
      p.value = NA  # p-value is not applicable for reference categories
    )

    #Names of the category
    caterogies_rows <- data.frame(
      term = c("sex", "age", "region",
               "overlaps","depression", "anxiety",
               "bipolar", "schizo", "adhd", 
               "id", "duration", "medications", "sleep_insomnia_class", "aggr_behav_class",
               "depress_anx_ocd_repet_behav_class", "irritability_class",
               "antiseizure_behav_class", 
               "adhd_meds_class", "adhd_aggr_class"),
      HR = NA,  # Reference category HR is always 1
      lower_CI = NA,  # Reference confidence interval is also 1
      upper_CI = NA,
      p.value = NA  # p-value is not applicable for reference categories
    )

    # Append reference categories to the cox_df
    cox_df <- bind_rows(cox_df, reference_rows)
    cox_df <- bind_rows(cox_df, caterogies_rows)


    cox_df[order(cox_df$term),]

    custom_order <- c(
      "medications", "Num_MedTakenRef", "Num_MedTakenLow Polypharmacy", "Num_MedTakenHigh Polypharmacy",
      "overlaps", "overlaps_eventRef", "overlaps_eventYes",
      "duration", "duration_ByEventRef", "duration_ByEventGreater than 365",
      "sleep_insomnia_class", "sleep_insomniaRef", "sleep_insomniaYes", 
      "aggr_behav_class", "aggr_behavRef", "aggr_behavYes", 
      "irritability_class", "irritabilityRef",  "irritabilityYes",
      "depress_anx_ocd_repet_behav_class", "depress_anx_ocd_repet_behavRef", "depress_anx_ocd_repet_behavYes", 
      "antiseizure_behav_class", "antiseizure_behavRef", "antiseizure_behavYes",
      "adhd_meds_class", "adhd_medsRef", "adhd_medsYes", 
      "adhd_aggr_class", "adhd_aggrRef", "adhd_aggrYes",
      # "ssris_used", "SSRIs_useRef", "SSRIs_useYes",
      # "aa_used", "antipsychotics_useRef", "antipsychotics_useYes",
      "sex","der_sexMale", "der_sexF", 
      "region", "pat_regionReference", "pat_regionE", "pat_regionS", "pat_regionW",
      "age", "age_startFollowUp_groupReference", "age_startFollowUp_groupAdolescence", "age_startFollowUp_groupEarly, Middle and Late Childhood",
      "depression", "depressive_diagn_histRef", "depressive_diagn_histYes",
      "anxiety", "anxiety_diagn_histRef", "anxiety_diagn_histYes",
      "bipolar","bipolar_diagn_histRef", "bipolar_diagn_histYes",
      "schizo", "schizo_diagn_histRef", "schizo_diagn_histYes",
      "adhd", "ADHD_diagn_histRef", "ADHD_diagn_histYes",
      "id", "ID_diagn_histRef", "ID_diagn_histYes"
    )

    cox_df$term <- factor(cox_df$term, levels = rev(custom_order))  # reversed so top = first

    cox_df <- cox_df %>% 
      filter(!is.na(term))

    ggplot(cox_df, aes(x = HR, y = term)) +
      geom_point(aes(color = ifelse(HR == 1, "Reference", "Estimated")), size = 5) +  # Different colors
      geom_errorbarh(data = cox_df %>% filter(HR != 1),
                     aes(xmin = lower_CI, xmax = upper_CI), height = 0.5, 
                     size = 1) +  # CI bars only for non-references
      geom_vline(xintercept = 1, linetype = "dashed", color = "red") +  # Reference line at HR = 1
      scale_x_log10() +  # Log scale for HR
      scale_color_manual(values = c("Reference" = "black", "Estimated" = "blue")) +  # Define colors
      labs(
        x = "Hazard Ratio (HR)",
        y = "",
        title = ""
      ) +
      theme_bw() +
      theme(
        axis.text.y = element_text(size = 18),
        axis.title.x = element_text(size = 18),
        legend.title = element_blank(),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(), 
      ) #1700 x 1600

#### Wald test for significance

    car::Anova(cox_psychotropic_HyT, type = 3, test.statistic = "Wald")

#### Survival plot

    ggsurvplot(survfit(cox_psychotropic_HyT), data = HyT_Exposed_3out5, 
               conf.int = TRUE, risk.table = TRUE, ggtheme = theme_bw(), 
               fontsize = 5, font.x = 12, font.tickslab = 12, font.y = 12, font.legend = 12)

#### Forest plot

    #1400 * 750
    HyT_Exposed_3out5_forest <- HyT_Exposed_3out5 %>% 
      rename(
        `History of schizophrenia` = schizo_diagn_hist, 
        `Place of residence` = pat_region, 
        `Follow-up overlapping with event` = overlaps_event, 
        `Number of medication taken` = Num_MedTaken,
        `Medication setting` = medication, 
        `History of ID`= ID_diagn_hist, 
        `Duration of medication events` = duration_ByEvent,  
         `Sex` = der_sex, 
        `History of depression` = depressive_diagn_hist,
        `History of bipolar dis.`= bipolar_diagn_hist, 
        `History of anxiety`= anxiety_diagn_hist, 
        `Age at first medication event`= age_startFollowUp_group, 
        `History of ADHD` = ADHD_diagn_hist, 
        `Meds for sleep/insomnia` = sleep_insomnia, 
        `Meds for aggressive behavior` = aggr_behav, 
        `Meds for depressive/anxiety/OCD repetitive behaviors` = depress_anx_ocd_repet_behav, 
        `Meds for irritability` = irritability, 
        `Meds for antiseizure with some effects on behavior` = antiseizure_behav, 
        `Meds for ADHD` = adhd_meds, 
        `Meds for ADHD for aggression` = adhd_aggr
        # `Antipsychotics use` = antipsychotics_use, 
        # `SSRIs use` = SSRIs_use
    )

    #`Number of medication taken`

    cox_psychotropic_HyT_2 <- coxph(Surv(tstart, tstop, fustat) ~  `Medication setting` + `Follow-up overlapping with event` + `Duration of medication events` + `Meds for aggressive behavior` + `Meds for depressive/anxiety/OCD repetitive behaviors` + `Meds for irritability` + `Meds for antiseizure with some effects on behavior` +  `Meds for ADHD` + `Meds for ADHD for aggression` + `Meds for sleep/insomnia` + `Sex` + `Place of residence` + `Age at first medication event` + `History of depression` + `History of anxiety` +  `History of bipolar dis.` + `History of schizophrenia` + `History of ADHD` + `History of ID`,
                                   data = HyT_Exposed_3out5_forest)

    ggforest(cox_psychotropic_HyT_2, data = HyT_Exposed_3out5_forest, fontsize = 1.2) #1800 * 1000

    # ggforest(cox_psychotropic_HyT, data = HyT_Exposed_3out5, fontsize = 0.70) #1400 * 750

#### Table for sensitivity analysis - polypharmacy definition

    metabolic_syndrome_option <- "HYT"

    summary_model <- summary(cox_psychotropic_HyT_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]

    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      paste0("Medication settingPolypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Medication settingPolypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
       paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
       paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      paste0("Polypharmacy >= ", polypharmacy_select, " day(s)" ),
      paste0("Polypharmacy < ", polypharmacy_select, " day(s)" ),

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL

    # fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/FollowUp/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", polypharmacy_select, ".csv"))

#### Table for sensitivity analysis - follow-up period

    metabolic_syndrome_option <- "HyT"

    summary_model <- summary(cox_psychotropic_HyT_2)

    # Hazard Ratios
    HR <- summary_model$coefficients[, "exp(coef)"]

    # Lower and upper bounds of 95% CI
    CI_lower <- summary_model$conf.int[, "lower .95"]
    CI_upper <- summary_model$conf.int[, "upper .95"]
    pval     <- summary_model$coefficients[, "Pr(>|z|)"]


    # Step 1: Create a named vector for display names and desired order
    variable_order <- c(
      "Number of medication takenLow Polypharmacy",
      "Number of medication takenHigh Polypharmacy",
      "Follow-up overlapping with eventYes",
      "Duration of medication eventsGreater than 365",
      "Meds for irritabilityYes",
      "Meds for depressive/anxiety/OCD repetitive behaviorsYes",
      "Meds for antiseizure with some effects on behaviorYes",
      "Meds for aggressive behaviorYes",
      "Meds for ADHDYes",
      "Meds for ADHD for aggressionYes",
      "Meds for sleep/insomniaYes",
      "SexF",
      "Place of residenceW",
      "Place of residenceS",
      "Place of residenceE",
      "Age at first medication eventAdolescence",
      "Age at first medication eventEarly, Middle and Late Childhood",
      "History of IDYes",
      "History of depressionYes",
      "History of bipolar dis.Yes",
      "History of anxietyYes",
      "History of ADHDYes",
      "History of schizophreniaYes"
    )

    display_names <- c(
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      "Follow-up overlap with medication event - Yes",
      "Duration of medication events > 365 days",
      "Medications for irritability - Yes",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      "Medications for antiseizure with some effects on behavior - Yes",
      "Medications for aggressive behavior - Yes",
      "Medications for ADHD - Yes",
      "Medications for ADHD for aggression - Yes",
      "Medications for sleep/insomnia - Yes",
      "Female",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      "History of ID - Yes",
      "History of depression - Yes",
      "History of bipolar disorder - Yes",
      "History of anxiety disorder - Yes",
      "History of ADHD - Yes",
      "History of schizophrenia - Yes"
    )
    names(display_names) <- variable_order

    # Step 2: Create the result table
    cox_results <- data.frame(
      Variable = rownames(summary_model$coefficients),
      HR = summary_model$coefficients[, "exp(coef)"],
      CI_lower = summary_model$conf.int[, "lower .95"],
      CI_upper = summary_model$conf.int[, "upper .95"],
      p_value = summary_model$coefficients[, "Pr(>|z|)"]
    )

    # Step 3: Format HR + CI
    cox_results$HR_CI <- sprintf("%.2f (%.2f–%.2f)", cox_results$HR, cox_results$CI_lower, cox_results$CI_upper)


    # Step 3: Format HR + CI
    cox_results$Variable <- gsub("\\`", "", cox_results$Variable)

    # Step 4: Keep only variables of interest, rename them, and order accordingly
    cox_results_filtered <- cox_results[match(variable_order, cox_results$Variable), ]

    cox_results_filtered$Variable <- display_names[match(cox_results_filtered$Variable, names(display_names))]

    # Step 5: Format p-values
    cox_results_filtered$p_value <- ifelse(cox_results_filtered$p_value < 0.05, "<0.05",
                                           formatC(cox_results_filtered$p_value, format = "f", digits = 3))

    # Step 6: Create final table
    final_table <- cox_results_filtered[, c("Variable", "HR_CI", "p_value")]
    colnames(final_table) <- c("Variable", "Hazard Ratio (95% CI)", "p-value")


    # Define reference entries to add
    reference_rows <- data.frame(
      Variable = c(
        "Monotherapy (reference)",
        "No overlap with medication event (reference)",
        "Duration of medication events 1–365 days (reference)",
        "No medications for irritability (reference)",
        "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
        "No medications for antiseizure with some effects on behavior (reference)",
        "No medications for aggressive behavior (reference)",
        "No medications for ADHD (reference)",
        "No medications for ADHD for aggression (reference)",
        "No medications for sleep/insomnia (reference)",
        "Male (reference)",
        "Region of residence: Midwest (reference)",
        "Age at first medication event: Adulthood (reference)",
        "No history of ID (reference)",
        "No history of depression (reference)",
        "No history of bipolar disorder (reference)",
        "No history of anxiety disorder (reference)",
        "No history of ADHD (reference)",
        "No history of schizophrenia (reference)"
      ),
      `Hazard Ratio (95% CI)` = "Reference",
      `p-value` = ""
    )


    colnames(reference_rows) <- colnames(final_table)
    # Combine with final results table
    final_table <- rbind(reference_rows, final_table)

    # Reorder rows to place reference above corresponding group
    desired_order <- c(
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",
      
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",
      
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",
      
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",
      
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",
      
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",
      
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",
      
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",
      
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",
      
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",
      
      "Male (reference)",
      "Female",
      
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",
      
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",
      
      "No history of ID (reference)",
      "History of ID - Yes",
      
      "No history of depression (reference)",
      "History of depression - Yes",
      
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",
      
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",
      
      "No history of ADHD (reference)",
      "History of ADHD - Yes",
      
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder according to the structure of reference + comparisons
    final_table <- final_table[match(desired_order, final_table$Variable), ]

    # Define group headers with placeholder rows
    group_headers <- data.frame(
      Variable = c(
        "Pharmacotherapy",
        "Follow-up overlap with medication event",
        "Duration of medication events",
        "Medications for irritability",
        "Medications for depressive/anxiety/OCD-repetitive behaviors",
        "Medications for antiseizure with some effects on behavior",
        "Medications for aggressive behavior",
        "Medications for ADHD",
        "Medications for ADHD for aggression",
        "Medications for sleep/insomnia",
        "Sex",
        "Region of residence",
        "Age at first medication event",
        "History of ID",
        "History of depression",
        "History of bipolar disorder",
        "History of anxiety disorder",
        "History of ADHD",
        "History of schizophrenia"
      ),
      `Hazard Ratio (95% CI)` = "",
      `p-value` = ""
    )

    colnames(group_headers) <- colnames(final_table)

    # Append group headers to final table
    final_table_with_headers <- rbind(group_headers, final_table)

    # Redefine order including the group headers
    final_order_with_groups <- c(
      "Pharmacotherapy",
      "Monotherapy (reference)",
      "Low polypharmacy (3 or fewer medications)",
      "High polypharmacy (more than 3 medications)",

      "Follow-up overlap with medication event",
      "No overlap with medication event (reference)",
      "Follow-up overlap with medication event - Yes",

      "Duration of medication events",
      "Duration of medication events 1–365 days (reference)",
      "Duration of medication events > 365 days",

      "Medications for irritability",
      "No medications for irritability (reference)",
      "Medications for irritability - Yes",

      "Medications for depressive/anxiety/OCD-repetitive behaviors",
      "No medications for depressive/anxiety/OCD-repetitive behaviors (reference)",
      "Medications for depressive/anxiety/OCD-repetitive behaviors - Yes",

      "Medications for antiseizure with some effects on behavior",
      "No medications for antiseizure with some effects on behavior (reference)",
      "Medications for antiseizure with some effects on behavior - Yes",

      "Medications for aggressive behavior",
      "No medications for aggressive behavior (reference)",
      "Medications for aggressive behavior - Yes",

      "Medications for ADHD",
      "No medications for ADHD (reference)",
      "Medications for ADHD - Yes",

      "Medications for ADHD for aggression",
      "No medications for ADHD for aggression (reference)",
      "Medications for ADHD for aggression - Yes",

      "Medications for sleep/insomnia",
      "No medications for sleep/insomnia (reference)",
      "Medications for sleep/insomnia - Yes",

      "Sex",
      "Male (reference)",
      "Female",

      "Region of residence",
      "Region of residence: Midwest (reference)",
      "Region of residence: West",
      "Region of residence: South",
      "Region of residence: East",

      "Age at first medication event",
      "Age at first medication event: Adulthood (reference)",
      "Age at first medication event: Adolescence",
      "Age at first medication event: Childhood",

      "History of ID",
      "No history of ID (reference)",
      "History of ID - Yes",

      "History of depression",
      "No history of depression (reference)",
      "History of depression - Yes",

      "History of bipolar disorder",
      "No history of bipolar disorder (reference)",
      "History of bipolar disorder - Yes",

      "History of anxiety disorder",
      "No history of anxiety disorder (reference)",
      "History of anxiety disorder - Yes",

      "History of ADHD",
      "No history of ADHD (reference)",
      "History of ADHD - Yes",

      "History of schizophrenia",
      "No history of schizophrenia (reference)",
      "History of schizophrenia - Yes"
    )

    # Reorder table to match group structure
    final_table <- final_table_with_headers[match(final_order_with_groups, final_table_with_headers$Variable), ]

    rownames(final_table) <- NULL

    # fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/FollowUp/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", follow_up, ".csv"))

    fwrite(final_table, paste0("Y:/Paula/Files_finish/NewFiles/2to64/SensitivityAnalysis_aim1/Polypharmacy/TableSensitivityAnalysis_", metabolic_syndrome_option, "_", polypharmacy_select, ".csv"))

#### Basehaz

Cumulative hazard stratified by medication

    # overlaps_event
    cox_psychotropic_HYT_strata <- coxph(Surv(tstart, tstop, fustat) ~strata(Num_MedTaken) + overlaps_event + duration_ByEvent + irritability + depress_anx_ocd_repet_behav +  antiseizure_behav + aggr_behav + adhd_meds + adhd_aggr + sleep_insomnia + der_sex + pat_region + age_startFollowUp_group + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist,  
                              data = HyT_Exposed_3out5)


    base_haz_strata <- basehaz(cox_psychotropic_HYT_strata) 

    lw <- 0.5

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time (days)", y = "Cumulative hazard", color = "") + 
      scale_color_manual(values = c("Monotherapy" = "#EF520F", "Low Polypharmacy" = "#430384", "High Polypharmacy" = "#156884")) + 
      theme_bw(base_size = 22) + 
      theme(
        panel.border = element_rect(size = lw, colour = 'black'),
        axis.line = element_line(size = lw),
        axis.ticks = element_line(size = lw),
        axis.text = element_text(size = 14),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(),
        legend.text = element_text(size = 21), 
        axis.text.x = element_text(size = 21), 
        axis.text.y = element_text(size = 21), 
        legend.title = element_text(face = "bold"), 
        legend.position = "bottom")

Stratified by age groups

    cox_psychotropic_HYT_strata <- coxph(Surv(tstart, tstop, fustat) ~ medication + overlaps_event + der_sex + duration_ByEvent + Num_MedTaken + strata(age_startFollowUp_group) + pat_region + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist, 
                              data = HyT_Exposed_3out5)



    base_haz_strata <- basehaz(cox_psychotropic_HYT_strata) 

    ggplot(base_haz_strata, aes(x = time, y = hazard, color = strata)) + 
      geom_line(linewidth = 2) + 
      labs(x = "Time", y = "Cumulative hazard") +  
      theme_bw(base_size = 22) 

#### Residual diagnosis

This residual diagnosis is to check the proportional hazards assumption
for time-fixed covariates with Schoenfeld Residuals. A p-value less than
0.05 suggests a violation of the proportional hazard assumption for that
covariate.

Observing the plot for each time-fixed covariate against time, the
residuals must display a random scatter around zero with no obvious
trend to the proportional hazard assumption holds.

    ph_test_HYT <- cox.zph(cox_psychotropic_HyT)
    print(ph_test_HBS)

According with the p-value for each covariate and the global test we can
assume the proportional hazards for the time-fixed covariates. You can
also do a graphical diagnostic.

    ggcoxzph(ph_test_HYT)

#### Influential observations

To test influential observations or outliers, we can visualize either
the `deviance residuals` or the `dfbeta` values.

    ggcoxdiagnostics(cox_psychotropic_HyT, type = "deviance", linear.predictions =  FALSE, ggtheme = theme_bw(base_size = 22))

    deviance_resid_HYT <- residuals(cox_psychotropic_HyT, type = "deviance")
    threshold <- 2 

    num_outliers_HYT <- sum(abs(deviance_resid_HYT) > threshold) 

    proportion_outliers <- num_outliers_HYT / length(deviance_resid_HYT) * 100

#### Multicollinearity test

##### Time-varying predictors

    #Select variables used in the model 
    HyT_Exposed_3out5_v2 <- HyT_Exposed_3out5 %>% 
      select(Num_MedTaken, overlaps_event, der_sex, duration_ByEvent, sleep_insomnia, aggr_behav, depress_anx_ocd_repet_behav,irritability, antiseizure_behav, adhd_meds, adhd_aggr, age_startFollowUp_group, pat_region, depressive_diagn_hist, anxiety_diagn_hist, bipolar_diagn_hist, schizo_diagn_hist, ADHD_diagn_hist, ID_diagn_hist)

    # function to get chi square p value and Cramers V
    f = function(x,y) {
      tbl = HyT_Exposed_3out5_v2 %>% dplyr::select(x,y) %>% table()
      chisq_pval = round(chisq.test(tbl)$p.value, 4)
      cramV = round(cramersV(tbl), 4)
      data.frame(x, y, chisq_pval, cramV) }

    # create unique combinations of column names

    # sorting will help getting a better plot (upper triangular)
    df_comb_HyT= data.frame(t(combn(sort(names(HyT_Exposed_3out5_v2)), 2)), stringsAsFactors = F)

    # apply function to each variable combination
    df_res_HyT = map2_df(df_comb_HyT$X1, df_comb_HyT$X2, f)

The following figure contains the p-value of the chi-square to test if
there is a significant association or not. It ranges from 0 (green
values) to 1 (red values). The number inside the color boxes are the
Cramer’s V value, a measure of association between two categorical
values, ranging from 0 to 1.

-   A Cramer’s V near to 1 (0.7 or above), indicates a strong
    association between the two variables, meaning that knowing the
    category of one variable gives substancial information about the
    other.

-   A Cramer’s V near to 0 indicates weak or negligible association
    (i.e., they are nearly independent)

-   Intermediate values, e.g., from 0.1 to 0.7, imply moderate
    association levels, where knowing one variable provides some
    information about the other, though not conclusively.

<!-- -->

    new_labels_x <- c("schizo_diagn_hist" = "History of schizophrenia",
                      "pat_region" = "Place of residence", 
                      "overlaps_event" = "Follow-up overlapping with event", 
                      "Num_MedTaken" = "Number of medication taken", 
                      #"medication" = "Medication setting", 
                      "ID_diagn_hist" = "History of ID", 
                      "duration_ByEvent" = "Duration of medication events", 
                      "der_sex" = "Sex", 
                      "depressive_diagn_hist" = "History of depression", 
                      "bipolar_diagn_hist" = "History of bipolar dis.", 
                      "anxiety_diagn_hist" = "History of anxiety", 
                      "age_startFollowUp_group" = "Age at first medication event", 
                      "ADHD_diagn_hist" = "History of ADHD", 
                      # "antipsychotics_use" = "Antipsychotics use", 
                      # "SSRIs_use"="SSRIs use", 
                      "sleep_insomnia" = "Meds for sleep/insomnia", 
                      "aggr_behav" = "Meds for aggressive behavior", 
                      "depress_anx_ocd_repet_behav" = "Meds for depressive/anxiety/OCD repetitive behaviors", 
                      "irritability" = "Meds for irritability", 
                      "antiseizure_behav" = "Meds for antiseizure with some effects on behavior", 
                      "adhd_meds" = "Meds for ADHD",
                      "adhd_aggr" = "Meds for ADHD for aggression")
    # plot results
    p3 <- df_res_HyT %>%
      ggplot(aes(x,y,fill=cramV))+
      geom_tile()+
      geom_text(aes(x,y,label=cramV), size = 5)+
      scale_fill_gradient2(low="#92e2a6", mid = "white", high="#faaf90", midpoint = 0.2) +
      scale_x_discrete(labels = new_labels_x) + 
      scale_y_discrete(labels = new_labels_x) +
      theme_classic() + 
      labs(
        title = "High blood pressure",
        x = "", 
        y = "", 
        fill = "Crammer's V"
      ) +
      theme(
        text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, hjust = 1)
      )

Looking at the results for the Cramer’s V, there only two variables with
a significant high correlation is medication taken and medication
setting.

Because number of medication taken brings more information, we decided
to exclude medication setting (polypharmacy, monotherapy).

## LDL

    metabolic_syndrome_related_diagn_Last <- metabolic_syndrome_related_diagn_Last %>% 
      mutate(PATIENT_ID = pat_id)

    LDL_Exposed_3out5 <- Creation_df_ByCondition("Low cholesterol level")

    #Classification of medications according with intended use 
    LDL_Exposed_3out5 <- LDL_Exposed_3out5 %>%
    mutate(sleep_insomnia = if_else(sleep_insomnia == "FALSE", "No", "Yes"),
           aggr_behav = if_else(aggr_behav == "FALSE", "No", "Yes"), 
           depress_anx_ocd_repet_behav = if_else(depress_anx_ocd_repet_behav == "FALSE", "No", "Yes"), 
           irritability = if_else(irritability == "FALSE", "No", "Yes"),
           antiseizure_behav = if_else(antiseizure_behav == "FALSE", "No", "Yes"),
           adhd_meds = if_else(adhd_meds == "FALSE", "No", "Yes"),
           adhd_aggr = if_else(adhd_aggr == "FALSE", "No", "Yes")
           )

### Cox proportional hazard model

    cox_psychotropic_LDL <- coxph(Surv(tstart, tstop, fustat) ~ overlaps_event + der_sex + duration_ByEvent + Num_MedTaken + age_startFollowUp_group + pat_region + depressive_diagn_hist + anxiety_diagn_hist + bipolar_diagn_hist + schizo_diagn_hist + ADHD_diagn_hist + ID_diagn_hist, 
                              data = LDL_Exposed_3out5)

    summary(cox_psychotropic_LDL)

#### Forest plot for publication

    # Fit Cox model (assuming your model is already created)
    cox_model <- cox_psychotropic_LDL

    # Extract hazard ratios (HR)
    cox_summary <- broom::tidy(cox_model, exponentiate = TRUE)

    # Extract confidence intervals separately
    conf_intervals <- confint(cox_model)
    conf_intervals <- exp(conf_intervals)  # Convert log HR to HR

    # Convert confidence intervals to a dataframe
    conf_df <- data.frame(term = rownames(conf_intervals),
                          lower_CI = conf_intervals[, 1],
                          upper_CI = conf_intervals[, 2])

    # Merge the two dataframes
    cox_df <- left_join(cox_summary, conf_df, by = "term")

    # Select relevant columns
    cox_df <- cox_df %>%
      select(term, estimate, lower_CI, upper_CI, p.value) %>%
      rename(HR = estimate)

    # Identify reference categories manually
    reference_rows <- data.frame(
      term = c("der_sexMale", "age_startFollowUp_groupReference", "pat_regionReference",
               "overlaps_eventRef","depressive_diagn_histRef", "anxiety_diagn_histRef",
               "bipolar_diagn_histRef", "schizo_diagn_histRef", "ADHD_diagn_histRef", 
               "ID_diagn_histRef", "duration_ByEventRef", "Num_MedTakenRef"),
      HR = 1,  # Reference category HR is always 1
      lower_CI = 1,  # Reference confidence interval is also 1
      upper_CI = 1,
      p.value = NA  # p-value is not applicable for reference categories
    )

    # Append reference categories to the cox_df
    cox_df <- bind_rows(cox_df, reference_rows)

    cox_df[order(cox_df$term),]

    # Define the correct order of variables as in the attached figure
    custom_order <- c(
      "Num_MedTakenRef", "Num_MedTakenLow Polypharmacy", "Num_MedTakenHigh Polypharmacy",
      "overlaps_eventRef", "overlaps_eventYes",
      "duration_ByEventRef", "duration_ByEventGreater than 365",
      "der_sexMale", "der_sexF",
      "pat_regionReference", "pat_regionE", "pat_regionS", "pat_regionW",
      "age_startFollowUp_groupReference", "age_startFollowUp_groupAdolescence", "age_startFollowUp_groupEarly, Middle and Late Childhood",
      "depressive_diagn_histRef", "depressive_diagn_histYes",
      "anxiety_diagn_histRef", "anxiety_diagn_histYes",
      "bipolar_diagn_histRef", "bipolar_diagn_histYes",
      "schizo_diagn_histRef", "schizo_diagn_histYes",
      "ADHD_diagn_histRef", "ADHD_diagn_histYes",
      "ID_diagn_histRef", "ID_diagn_histYes"
    )

    # Assign custom order to the factor levels
    cox_df$term <- factor(cox_df$term, levels = rev(custom_order))

    # Generate the forest plot
    ggplot(cox_df, aes(x = HR, y = term)) +
      geom_point(aes(color = ifelse(HR == 1, "Reference", "Estimated")), size = 5) +  # Different colors
      geom_errorbarh(data = cox_df %>% filter(HR != 1),
                     aes(xmin = lower_CI, xmax = upper_CI), height = 0.5,
                     size = 1) +  # CI bars only for non-references
      geom_vline(xintercept = 1, linetype = "dashed", color = "red") +  # Reference line at HR = 1
      scale_x_log10() +  # Log scale for HR
      scale_color_manual(values = c("Reference" = "black", "Estimated" = "blue")) +  # Define colors
      labs(
        x = "Hazard Ratio (HR)",
        y = "",
        title = "Cox Proportional Hazard Model"
      ) +
      theme_bw() +
      theme(
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 12),
        legend.title = element_blank(),
        panel.grid.major =  element_blank(),
        panel.grid.minor = element_blank()
      ) #1200 x 700

#### Forest plot

    var_labels <- c("schizo_diagn_hist" = "History of schizophrenia",
                      "pat_region" = "Place of residence", 
                      "overlaps_event" = "Follow-up overlapping with event", 
                      "Num_MedTaken" = "Number of medication taken", 
                      #"medication" = "Medication setting", 
                      "ID_diagn_hist" = "History of ID", 
                      "duration_ByEvent" = "Duration of medication events", 
                      "der_sex" = "Sex", 
                      "depressive_diagn_hist" = "History of depression", 
                      "bipolar_diagn_hist" = "History of bipolar dis.", 
                      "anxiety_diagn_hist" = "History of anxiety", 
                      "age_startFollowUp_group" = "Age at first medication event", 
                      "ADHD_diagn_hist" = "History of ADHD", 
                      "antipsychotics_use" = "Antipsychotics use", 
                      "SSRIs_use"="SSRIs use")

    #1400 * 750
    LDL_Exposed_3out5_forest <- LDL_Exposed_3out5 %>% 
      rename(
        `History of schizophrenia` = schizo_diagn_hist, 
        `Place of residence` = pat_region, 
        `Follow-up overlapping with event` = overlaps_event, 
        `Number of medication taken` = Num_MedTaken,
        #`medication` = Medication setting, 
        `History of ID`= ID_diagn_hist, 
        `Duration of medication events` = duration_ByEvent,  
         `Sex` = der_sex, 
        `History of depression` = depressive_diagn_hist,
        `History of bipolar dis.`= bipolar_diagn_hist, 
        `History of anxiety`= anxiety_diagn_hist, 
        `Age at first medication event`= age_startFollowUp_group, 
        `History of ADHD` = ADHD_diagn_hist, 
        `Meds for sleep/insomnia` = sleep_insomnia, 
        `Meds for aggressive behavior` = aggr_behav, 
        `Meds for depressive/anxiety/OCD repetitive behaviors` = depress_anx_ocd_repet_behav, 
        `Meds for irritability` = irritability, 
        `Meds for antiseizure with some effects on behavior` = antiseizure_behav, 
        `Meds for ADHD` = adhd_meds, 
        `Meds for ADHD for aggression` = adhd_aggr
        # `Antipsychotics use` = antipsychotics_use, 
        # `SSRIs use` = SSRIs_use
    )

    cox_psychotropic_LDL_2 <- coxph(Surv(tstart, tstop, fustat) ~  `Number of medication taken` + `Follow-up overlapping with event` + `Duration of medication events` + `Meds for aggressive behavior` + `Meds for depressive/anxiety/OCD repetitive behaviors` + `Meds for irritability` + `Meds for antiseizure with some effects on behavior` +  `Meds for ADHD` + `Meds for ADHD for aggression` + `Sex` + `Place of residence` + `Age at first medication event` + `History of depression` + `History of anxiety` +  `History of bipolar dis.` + `History of schizophrenia` + `History of ADHD` + `History of ID`,
                                   data = LDL_Exposed_3out5_forest)

    ggforest(cox_psychotropic_LDL_2, data = LDL_Exposed_3out5_forest, fontsize = 0.55) #1400 * 750

# Model diagnostics: deviance residuals

    dev_res1 <- residuals(cox_psychotropic_WG_2, type = "deviance")
    dev_res2 <- residuals(cox_psychotropic_HC_2, type = "deviance")
    dev_res3 <- residuals(cox_psychotropic_HyT_2, type = "deviance")
    dev_res4 <- residuals(cox_psychotropic_HBS_2, type = "deviance")

    # Set up 2x2 panel
    par(mfrow = c(2, 2),    # 2 rows, 2 columns
        mar = c(4, 4, 2, 1))  # Margins: bottom, left, top, right

    # Plot 1
    plot(dev_res1,
         ylab = "Deviance residuals",
         xlab = "Observation index",
         main = "Weight gain",
         pch = 20)
    abline(h = 0, col = "red", lty = 2)

    # Plot 2
    plot(dev_res2,
         ylab = "Deviance residuals",
         xlab = "Observation index",
         main = "High LDL cholesterol level",
         pch = 20)
    abline(h = 0, col = "red", lty = 2)

    # Plot 3
    plot(dev_res3,
         ylab = "Deviance residuals",
         xlab = "Observation index",
         main = "High blood pressure",
         pch = 20)
    abline(h = 0, col = "red", lty = 2)

    # Plot 4
    plot(dev_res4,
         ylab = "Deviance residuals",
         xlab = "Observation index",
         main = "High blood sugar levels",
         pch = 20)
    abline(h = 0, col = "red", lty = 2)

    # Reset to default layout
    par(mfrow = c(1, 1))
