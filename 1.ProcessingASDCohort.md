# Identification of cohort: individuals with ASD who received psychotropic medication and with at least one diagnosis of metabolic syndrome related conditions. 
The overall workflow for the identification of the ASD cohort and those who received psychotropic medication are in https://github.com/polijaimesb/2024_PharmacotherapyPatternsForChallengingBehavior_ASD (1.ASDCohortSelection.md).
    
    library(data.table) 
    library(dplyr) 
    library(tidyr)
    library(ggplot2)
    library(RColorBrewer)
    library(stringr) #For the OUD part
    library(AdhereR)

Here, we are going to use the file that contains the individuals
receiving pharmacotherapy between 2012 to 2021.

    claims_prescriptions <- fread("Y:/Paula/Files_finish/NewFiles/2to64/090324_PharmacotherapyAndABA_2012-2022_2Diag_FirstDiag_R419.csv")

    invisible(gc())

# Exclusion criteria

## Patients with a prescription of medications before 2012

Here, we are going to exclude the individual who received a prescription
of any of the selected medications before 2012, to ensure we have new
users.

    all_claims <- select(fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv"),
                         pat_id, month_id, generic_name) %>% 
      mutate(year = as.numeric(substr(month_id, 1,4))) %>% 
      select(-month_id) %>%
      unique

    gc()

Extract patients with a prescription before 2012 and filter the patients
who received the medications selected.

    #Select the generic names of the medications
    selected_meds <- claims_prescriptions %>% 
      select(generic_name) %>% 
      unique %>% 
      unlist 

    #Identify the patients with a prescription before 2012 and with the medications above 
    all_patients_2012 <- all_claims %>% 
      filter(!is.na(generic_name) & 
               year < 2012 & 
               generic_name %in% selected_meds) %>% 
      select(pat_id) %>% 
      unique %>% 
      unlist 

    #Delete those patients from the principal dataset 
    claims_prescriptions <- claims_prescriptions %>% 
      filter(!pat_id %in% all_patients_2012)

## Check days of supply

In some cases, there are NA values or negative values for the days of
supply. We are going to check the distribution and observe what we
should we do to manage those type of cases.

    #Verify duplicated entries
    claims_prescriptions <- claims_prescriptions %>% 
      select(-V1) %>% 
      distinct()
      
    #Counting the days of supply 
    days_supply_count <- claims_prescriptions %>%
      group_by(dayssup) %>% 
      count() %>% 
      ungroup() %>% 
      mutate(dayssup = ifelse(is.na(dayssup), -1, dayssup))

    #Selecting days of supply and visualize it in a histogram
    days_supply <- claims_prescriptions %>%
      select(dayssup) %>% 
      unlist()

    hist(days_supply)

According with the histogram, the majority of the prescriptions have 30
days as days of supply, with other prescriptions having 90 days. Now,
calculating the proportion of prescription with days of supply higher
than 90 dayY:

    sum(days_supply_count$n[days_supply_count$dayssup > 90]) / sum(days_supply_count$n) * 100

Just 0.015% of the total prescriptions have days of supply higher than
90 days. We can adjust the maximum of days of supply to 90 days.

    claims_prescriptions <- claims_prescriptions %>% 
      mutate(dayssup = ifelse(dayssup > 90, 90, dayssup))

For the invalid values we have:

    days_supply_count$n[days_supply_count$dayssup == -1] / sum(days_supply_count$n) * 100

Only 0.24% of the prescriptions have invalid values in the days of
supply. We are going to delete those claims but this option could change
in the future according with collaborators decisions.

Total of patients after deleting the invalid days of supply

    claims_prescriptions <- claims_prescriptions %>% 
      filter(!is.na(dayssup))

    length(unique(claims_prescriptions$pat_id))

## Check type of drug

This step is to verify that medications used here are not
bulk/injectable medications. There is an option in the USC column called
“CRUDE/BULK MEDICINAL” that we are going to use to delete those type of
drugs.

First, calculate the number of prescriptions with such classification.

    claims_prescriptions %>% 
      group_by(usc_name) %>% 
      count() %>% 
      ungroup()

Because the classification of crude/bulk medicinal are low, we proceed
to delete those.

    claims_prescriptions <- claims_prescriptions %>% 
      filter(usc_name != "CRUDE/BULK MEDICINAL")

We then only keep prescriptions labeled as “oral” in their route.

    claims_prescriptions <- claims_prescriptions %>% 
      filter(route =="ORAL")

## Diagnosis of metabolic syndrome and related conditions

It is important to do a exploratory analysis first of the metabolic
syndrome and related conditions year by year and also to detect if there
are patients with those diagnosis before 2012.

    #Load the entire claims to extract the age of the second diagnosis
    claims_diagnosis <-  fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
      select(pat_id, from_dt, starts_with("diag")) %>%
      filter(pat_id %in% unlist(unique(claims_prescriptions$pat_id)) & 
               diagprc_ind != -1) %>% 
      select(-diagprc_ind) %>%
      pivot_longer(
        cols = -c(pat_id,from_dt), 
        names_to = "diagn_code",
        values_to = "dx_cd"
      ) %>% 
      select(-diagn_code) %>%
      distinct() %>% 
      filter(dx_cd != "" & 
               !is.na(dx_cd)) %>% 
      arrange(from_dt, pat_id) %>% 
      distinct() %>% 
      mutate(year = as.numeric(as.numeric(format(from_dt, '%Y'))))

    gc()

The following ICD-x codes are related to metabolic syndrome, weight
gain, high cholesterol levels, low cholesterol levels, sugar in
blood-related conditions and hypertension. These codes were discussed
and revised by a physician.

    metabolic_syndrome <- c("E8881", "2777")
    weight_gain <- c("R635", "7831", "E6601", "E6609", "E669", "27801", "27800") 
    highLevel_cholesterol <- c("E7800", "E781", "E782", "E785", "2720", "2721", "2722", "2724")
    lowLevel_cholesterol <- c("E786", "2725")
    HighBlood_sugar <- c("R739","E1165", "E1365","E0965","E0865","79029","25080","24980")
    Hypertension <- c("I10", "4010","4011","4019")

    all <- c(weight_gain,
             highLevel_cholesterol,
             lowLevel_cholesterol,
             HighBlood_sugar,
             Hypertension)

Create a table with the metabolic syndrome and related conditions, and
categorized the codes.

    metabolic_syndrome_related_diagn <- claims_diagnosis %>% 
      filter(dx_cd %in% all) %>% 
      mutate(descrip_diag = case_when(
        #dx_cd %in% metabolic_syndrome ~ "Metabolic Syndrome",
        dx_cd %in% weight_gain ~ "Weight gain",
        dx_cd %in% highLevel_cholesterol ~ "High cholesterol level",
        dx_cd %in% lowLevel_cholesterol ~ "Low cholesterol level",
        dx_cd %in% HighBlood_sugar ~ "High blood sugar",
        dx_cd %in% Hypertension ~ "Hypertension"
      ))

We have to delete the patients with a metabolic syndrome diagnosis and
related conditions before 2012.

    patients_MetabolicSyndrome_2012 <- metabolic_syndrome_related_diagn %>% 
      filter(year < 2012) %>% 
      select(pat_id) %>% 
      unlist %>% 
      unique 

    claims_prescriptions <- claims_prescriptions %>% 
      filter(!pat_id %in% patients_MetabolicSyndrome_2012)

## ASD diagnosis prior to the first prescription

    # claims_prescriptions <- fread("Y:/Paula/Files_finish/NewFiles/2to64/090324_OnlyPharmacotherapy_SurvivalAnalysis_KeepNAZip.csv")


    claims_diagnosis <-  fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
      select(pat_id, from_dt, starts_with("diag")) %>%
      filter(pat_id %in% unlist(unique(claims_prescriptions$pat_id)) & 
               diagprc_ind != -1) %>% 
      select(-diagprc_ind) %>%
      pivot_longer(
        cols = -c(pat_id,from_dt), 
        names_to = "diagn_code",
        values_to = "dx_cd"
      ) %>% 
      select(-diagn_code) %>%
      distinct() %>% 
      filter(dx_cd != "" & 
               !is.na(dx_cd)) %>% 
      arrange(from_dt, pat_id) %>% 
      distinct() %>% 
      mutate(year = as.numeric(as.numeric(format(from_dt, '%Y'))))

    invisible(gc())

    #Save the file for later
    fwrite(claims_diagnosis, "Y:/Paula/Files_finish/NewFiles/2to64/090324_diagnosis_PharmacotherapyAndABA_AllYears.csv")

In our actual cohort, we are verifying that patients has at least 2 ASD
diagnosis codes, but we are not verifying that the diagnosis are
occurring before the first prescription.

Select the patient ID, service date of the first prescription.

    firstPrescription <- claims_prescriptions %>% 
      arrange(from_dt_claim, pat_id) %>% 
      select(from_dt_claim, pat_id, medication) %>%
      group_by(pat_id) %>% 
      slice(1) %>% 
      ungroup()

Now, select the diagnosis of autism and dates of these patients and
compare. Because we were losing some patients and we have some patients
with a diagnosis of autism the same day as the first prescription, we
are going to evaluate that the first prescription is after the second
diagnosis or during the first and second diagnosis.

    ASD_diagnoses_code <- c("F84","F840","F843","F845","F849","F848", 
                            "2990","29900","29901","2998","29980","29981","2999",
                            "29990","29991","299","2991","29910","29911")

    autism_diagnosis <- claims_diagnosis %>% 
      filter(dx_cd %in% ASD_diagnoses_code & 
               pat_id %in% firstPrescription$pat_id) %>% 
      arrange(from_dt, pat_id) %>% 
      unique 
      

    second_autism_diagnosis <- autism_diagnosis %>% 
      group_by(pat_id) %>% 
      slice(2) %>% 
      ungroup() %>% 
      mutate(last_autism_dt = from_dt) %>% 
      select(pat_id, last_autism_dt)


    first_autism_diagnosis <- autism_diagnosis %>% 
      group_by(pat_id) %>% 
      slice(1) %>% 
      ungroup() %>% 
      mutate(first_autism_dt = from_dt) %>% 
      select(pat_id, first_autism_dt)

    #Join all the  dataframes
    diagnosisAndPrescriptions <- firstPrescription %>% 
      left_join(first_autism_diagnosis, by = "pat_id") %>% 
      left_join(second_autism_diagnosis, by = "pat_id") %>%
      arrange(from_dt_claim, pat_id)

Now, just include the patients with a diagnosis before the first
prescription.

    ASDPrior_1stPrescrip <- diagnosisAndPrescriptions %>% 
      group_by(pat_id) %>% 
      mutate(
        from_dt_claim = as.Date(from_dt_claim, "%Y-%m-%d"), 
        first_autism_dt = as.Date(first_autism_dt, "%Y-%m-%d"), 
        last_autism_dt = as.Date(last_autism_dt, "%Y-%m-%d")
      ) %>%
      filter((from_dt_claim >= first_autism_dt & from_dt_claim <= last_autism_dt) |
               from_dt_claim >= last_autism_dt) %>% 
      ungroup()

Finally, obtain the prescriptions for the patients with a ASD diagnosis
before the first prescription.

    claims_prescriptions <- claims_prescriptions %>% 
      filter(pat_id %in% ASDPrior_1stPrescrip$pat_id)

## Continuous enrollment prior the first prescription

In the current process, we are checking that the patient has been
enrolled at least 12 months, without verification of continuance. This
is fundamental to include patients with a verification of continuous
enrollment.

First, select the patient ID and the monthID of the first prescription.

    firstPrescription <- claims_prescriptions %>% 
      arrange(month_id, pat_id) %>% 
      select(month_id, pat_id, medication, from_dt_claim) %>%
      group_by(pat_id) %>% 
      slice(1) %>% 
      ungroup()

    ExpectedMonths_beforeFirst <- firstPrescription %>% 
      group_by(pat_id) %>% 
      mutate(
        month_id_prescrip = as.numeric(month_id),
        from_dt_claim = as.Date(from_dt_claim, "%Y-%m-%d"),
        end_date_prior = gsub("-", "", substr(from_dt_claim - 360, 1, 7))
      ) %>% 
      select(pat_id, month_id_prescrip, end_date_prior)

Then, load the file for the enrollment information and filtered by the
patients ID from the claims prescription data.

    demographicASD_enrll2<-fread("Y:/enroll2.csv") %>% 
      filter(pat_id %in% firstPrescription$pat_id) %>% 
      arrange(month_id, pat_id) %>% 
      mutate(year = substr(month_id, 1, 4))

    #Count the months for each year and by patient ID
    EnrollYearCount <- demographicASD_enrll2 %>% 
      left_join(ExpectedMonths_beforeFirst, by = "pat_id") %>% 
      group_by(pat_id) %>% 
      filter(month_id >= end_date_prior & 
               month_id <= month_id_prescrip)

    CountEnroll <- EnrollYearCount %>% 
      count() %>% 
      ungroup()
      
    AtLeast1Year_Prior <- CountEnroll %>% 
      filter(n >= 12)

    NoYear <- CountEnroll %>% 
      filter(n < 12)

However, we were losing some patients doing it by that. So, after
discussing how to evaluate continuous enrollment, we decided to include
the patients if they have ANY records prior the 12 months of the first
prescription. For this, we will use the entire dataset.

    eval_continuation <- select(fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv"),
                                pat_id, month_id) %>% 
      filter(pat_id %in% unique(firstPrescription$pat_id)) %>% 
      unique 


    EvalRecords_12Months <-  eval_continuation %>% 
      left_join(ExpectedMonths_beforeFirst, by = "pat_id") %>% 
      group_by(pat_id) %>% 
      filter(month_id >= end_date_prior & 
               month_id <= month_id_prescrip)

Total of patients after changing filter.

    length(unique(EvalRecords_12Months$pat_id))

After doing this we can observe that we are not losing any patient.

By now, I am going to work with the at least 1 year of enrollment prior
de first prescription.

    claims_prescriptions <- claims_prescriptions %>% 
      filter(pat_id %in% AtLeast1Year_Prior$pat_id) 

## Total prescription and patients - metabolic syndrome

    patients_metabolicSyndrome <- metabolic_syndrome_related_diagn %>% 
      filter(pat_id %in% unlist(unique(claims_prescriptions$pat_id))) %>% 
      select(pat_id) %>% 
      unique %>% 
      unlist

    claims_metabolicSyndrome <- claims_prescriptions %>% 
      filter(pat_id %in% patients_metabolicSyndrome)

    nrow(claims_metabolicSyndrome)
